import{p as r,a as p,w as P}from"./chunk-EPOLDU6W-CP3WDhNt.js";function H({cameraEnabled:e,isPlaying:s,isReading:t,isLoading:i,tangibleInstance:o,onCameraToggle:a,onPlayStop:l,onRead:d}){return r.jsxs("header",{className:"header",role:"banner",children:[r.jsx("div",{className:"logo-container",children:r.jsx("img",{src:"https://armbennett.github.io/tangible-11ty/assets/img/tibbl-logo.png",alt:"Application logo",className:"logo"})}),r.jsxs("nav",{className:"header-buttons",role:"navigation","aria-label":"Main navigation",children:[r.jsxs("button",{className:"header-button",onClick:a,"aria-label":e?"Disable camera":"Enable camera","aria-pressed":e,disabled:i||!o,children:[r.jsx("i",{className:"fa-solid fa-camera fa-2xl","aria-hidden":"true"}),r.jsx("span",{children:"Camera"})]}),r.jsxs("button",{className:"header-button",onClick:l,"aria-label":s?"Stop code execution":"Play and execute code","aria-pressed":s,disabled:i||!o,children:[r.jsx("i",{className:`fa-solid ${s?"fa-stop":"fa-play"} fa-2xl`,"aria-hidden":"true"}),r.jsx("span",{children:s?"Stop":"Play"})]}),r.jsxs("button",{className:"header-button",onClick:d,"aria-label":t?"Stop reading code":"Read out code text","aria-pressed":t,disabled:i||!o,children:[r.jsx("i",{className:"fa-brands fa-readme fa-2xl","aria-hidden":"true"}),r.jsx("span",{children:t?"Stop":"Read"})]})]})]})}function B({cameraEnabled:e}){return r.jsxs(r.Fragment,{children:[e&&r.jsx("section",{className:"camera-section",role:"region","aria-label":"Camera view",children:r.jsx("div",{className:"video-container",children:r.jsx("canvas",{id:"video-canvas",width:"640",height:"480","aria-label":"Code tile detection overlay"})})}),!e&&r.jsx("canvas",{id:"video-canvas",width:"640",height:"480",style:{display:"none"}})]})}function T({threadNumber:e,value:s,onChange:t,soundSets:i}){const o=`thread${e}`,a=`Thread ${e}`;return r.jsxs("div",{className:"dropdown-group",children:[r.jsx("label",{htmlFor:o,className:"dropdown-label",children:a}),r.jsx("select",{id:o,className:"dropdown",value:s,onChange:l=>t(l.target.value),"aria-label":`Select ${a} sound options`,children:i.map(l=>r.jsx("option",{value:l.value,children:l.label},l.value))})]})}function z({cameraEnabled:e,codeText:s,textareaRef:t,soundSets:i,soundSetOptions:o,onCodeTextChange:a,onSoundSetChange:l}){return r.jsxs("section",{className:`output-section ${e?"camera-active":""}`,role:"region","aria-label":"Code output and thread selection",children:[r.jsx("div",{className:"textbox-container",children:r.jsx("textarea",{ref:t,value:s,onChange:d=>a(d.target.value),className:"output-textbox",placeholder:`Thread 1
Loop 4 times
Play 5
End loop
Play 7

Thread 2
Delay 4
Loop 3 times
Play 8
End loop`,"aria-label":"Code output text area"})}),r.jsxs("div",{className:"dropdown-container",children:[r.jsx(T,{threadNumber:1,value:i[0],onChange:d=>l(0,d),soundSets:o}),r.jsx(T,{threadNumber:2,value:i[1],onChange:d=>l(1,d),soundSets:o}),r.jsx(T,{threadNumber:3,value:i[2],onChange:d=>l(2,d),soundSets:o})]})]})}function M(e){p.useEffect(()=>{if(!e)return;let s=null,t=[];const i=()=>{const n=document.getElementById("video-canvas-video"),c=document.getElementById("video-canvas");if(!n||!c){s=requestAnimationFrame(i);return}const u=c.getContext("2d");if(!u){s=requestAnimationFrame(i);return}if(n.readyState<2){s=requestAnimationFrame(i);return}const f=c.width,h=c.height;u.clearRect(0,0,f,h),u.save(),u.translate(f,0),u.scale(-1,1),u.drawImage(n,0,0,f,h),u.restore(),u.fillStyle="rgba(255, 0, 0, 0.3)",u.strokeStyle="rgba(255, 0, 0, 0.8)",u.lineWidth=2;for(let S=0;S<t.length;S++){const y=t[S];u.beginPath(),u.arc(y.x,y.y,y.radius,0,Math.PI*2),u.fill(),u.stroke()}s=requestAnimationFrame(i)},o=n=>{t=n.detail.topcodes},a=()=>{const n=document.getElementById("video-canvas-video"),c=document.getElementById("video-canvas"),u=document.querySelector(".video-container");if(n&&c&&u){n.style.display="none",(c.width!==640||c.height!==480)&&(c.width=640,c.height=480),u.contains(c)||u.appendChild(c),c.style.display="block",c.style.position="relative",c.style.width="100%",c.style.height="auto",c.style.maxHeight="50vh",c.style.objectFit="contain";const f=()=>{s||i()};return n.addEventListener("loadedmetadata",f),n.addEventListener("playing",f),n.readyState>=2&&f(),()=>{n.removeEventListener("loadedmetadata",f),n.removeEventListener("playing",f)}}},l=setInterval(()=>{document.getElementById("video-canvas-video")&&(a(),clearInterval(l))},100),d=setTimeout(()=>clearInterval(l),5e3);return window.addEventListener("topcodes-detected",o),()=>{clearInterval(l),clearTimeout(d),window.removeEventListener("topcodes-detected",o),s&&cancelAnimationFrame(s)}},[e])}function V(e,s,t){p.useEffect(()=>{if(!e)return;const i=setInterval(()=>{s&&!e.synthesis.speaking&&t(!1)},100);return()=>clearInterval(i)},[e,s,t])}async function D(e,s){const i=await(await fetch(`${e}/assets/js/howler.js`)).text(),o=document.createElement("script");o.textContent=i,document.head.appendChild(o);const l=await(await fetch(`${e}/assets/js/topcodes.js`)).text(),d=document.createElement("script");d.textContent=l,document.head.appendChild(d);let u=(await(await fetch(`${e}/assets/js/tangible.js`)).text()).replace("export default class Tangible","window.Tangible = class Tangible");u=u.replace(/setupTangible\(\) \{[\s\S]*?setVideoFrameCallback\("video-canvas", function \(jsonString\) \{[\s\S]*?\}, this\);[\s\S]*?\}/,`setupTangible() {
        this.setVideoCanvasHeight('video-canvas');
        let tangible = this;
        
        TopCodes.setVideoFrameCallback("video-canvas", function (jsonString) {
            var json = JSON.parse(jsonString);
            var topcodes = json.topcodes;
            tangible.currentCodes = topcodes;
            tangible.once = true;
            
            const event = new CustomEvent('topcodes-detected', { 
                detail: { topcodes: topcodes } 
            });
            window.dispatchEvent(event);
        }, this);
    }`);const f=document.createElement("script");if(f.textContent=u,document.head.appendChild(f),await new Promise(h=>setTimeout(h,200)),window.Tangible){const h=new window.Tangible;return h.setupTangible(),s(h,"Numbers",0),s(h,"Notifications",1),s(h,"Notifications",2),h}else return console.error("window.Tangible not available"),null}function O(e,s,t,i){p.useEffect(()=>{(async()=>{try{const a=await D(e,i);s(a),t(!1)}catch(a){console.error("Error loading scripts:",a),t(!1)}})()},[e,s,t,i])}let C=!1,w=[];function U(e,s,t,i){p.useEffect(()=>{const o=a=>{a.touches.length===3&&(a.preventDefault(),C&&(w.forEach(l=>clearTimeout(l)),w=[],t&&t.synthesis.cancel(),C=!1),s&&t?(C=!0,(async()=>{t.readCode("3");const d=setTimeout(async()=>{if(!C)return;t.readCode("2");const n=setTimeout(async()=>{if(!C)return;t.readCode("1");const c=setTimeout(()=>{C&&(C=!1,w=[],e())},1e3);w.push(c)},1e3);w.push(n)},1e3);w.push(d)})()):e())};return document.addEventListener("touchstart",o,{passive:!1}),()=>{document.removeEventListener("touchstart",o),w.forEach(a=>clearTimeout(a)),w=[],C=!1}},i)}function W(e){return e.replace(/<br\/>/g,`
`).replace(/,\s*X:\[object Object\]/g,"").toLowerCase().replace(/(^|\n)([a-z])/g,(s,t,i)=>t+i.toUpperCase()).replace(/x/g,"X")}function $(e){const s=e.split(`
`).map(o=>o.trim().toLowerCase()),t=[];let i=!1;for(let o=0;o<s.length;o++){const a=s[o];if(a.startsWith("loop"))t.push({type:"loop",index:o+1});else if(a.startsWith("end loop")||a.startsWith("endloop")){if(t.length===0||t[t.length-1].type!=="loop")return{valid:!1,error:`Unexpected end loop at position ${o+1}`};t.pop()}else if(a.startsWith("if"))t.push({type:"if",index:o+1});else if(a.startsWith("end if")||a.startsWith("endif")){if(t.length===0||t[t.length-1].type!=="if")return{valid:!1,error:`Unexpected end if at position ${o+1}`};t.pop()}else if(a.startsWith("function"))t.push({type:"function",index:o+1});else if(a.startsWith("end function")||a.startsWith("endfunction")){if(t.length===0||t[t.length-1].type!=="function")return{valid:!1,error:`Unexpected end function at position ${o+1}`};t.pop()}else if(a.startsWith("x =")||a.startsWith("x="))i=!0;else if((a.startsWith("play x")||a.startsWith("if x"))&&!i)return{valid:!1,error:`Variable used at ${o+1} without being set.`}}if(t.length>0){const o=t[t.length-1];return{valid:!1,error:`Missing end tile for ${o.type} in position ${o.index}.`}}return{valid:!0}}let v=!1,m=null;function q(e,s,t,i,o,a){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(m&&(clearInterval(m),m=null),e.isAudioPlaying()||v){e.stopAllSounds(),a(!1),v=!1;return}if(v=!0,s){const d=e.scanCode();if(d){const n=W(d);o(n);const c=$(n);if(!c.valid&&c.error){e.readCode(c.error),v=!1;return}n&&n.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(n),a(!0),m=setInterval(()=>{e.isAudioPlaying()||(a(!1),v=!1,m&&(clearInterval(m),m=null))},100)):v=!1;return}v=!1}const l=i.current?.value||t;if(l&&l.trim()){const d=$(l);if(!d.valid&&d.error){e.readCode(d.error),v=!1;return}}l&&l.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(l),a(!0),m=setInterval(()=>{e.isAudioPlaying()||(a(!1),v=!1,m&&(clearInterval(m),m=null))},100)):(e.readCode("No code to run."),v=!1)}}let g=!1;function _(e,s,t,i,o,a){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(e.synthesis.speaking||g){e.synthesis.cancel(),a(!1),g=!1;return}if(e.isAudioPlaying()){e.stopAllSounds();return}if(g=!0,s){const d=e.scanCode();if(d){const n=W(d);o(n),n&&n.trim()?(e.readCode(n),a(!0)):g=!1;return}g=!1}const l=i.current?.value||t;l&&l.trim()?(e.readCode(l),a(!0)):(e.readCode("No code to read."),g=!1)}}function L(e,s,t,i){const o=new window.Howl({src:[`${i}/assets/sound/${s}.mp3`],volume:.2,sprite:e.soundSets[s]});e.threads[t]=o}const E="https://raw.githubusercontent.com/armbennett/tangible-11ty/main",J=[{value:"Numbers",label:"Numbers"},{value:"MusicLoops1",label:"Music Loops 1"},{value:"Mystery",label:"Mystery"},{value:"Notifications",label:"Notifications"},{value:"OdeToJoy",label:"Ode to Joy"},{value:"FurElise",label:"Fur Elise"}];function G(){const[e,s]=p.useState(!1),[t,i]=p.useState(""),[o,a]=p.useState(!0),[l,d]=p.useState(["Numbers","Notifications","Notifications"]),[n,c]=p.useState(null),[u,f]=p.useState(!1),[h,S]=p.useState(!1),y=p.useRef(null),A=p.useCallback((x,b,j)=>{L(x,b,j,E)},[]);M(e),V(n,u,f),O(E,c,a,A);const N=q(n,e,t,y,i,S),k=_(n,e,t,y,i,f);U(N,e,n,[n,e,t]);const F=()=>{if(!n){console.error("Tangible instance not initialized");return}const x=!e;n.cameraStatus=x,window.TopCodes&&(window.TopCodes.startStopVideoScan("video-canvas",n.mode),x||setTimeout(()=>{delete window.TopCodes._mediaStreams["video-canvas"]},100)),s(x)},R=(x,b)=>{const j=[...l];j[x]=b,d(j),n&&L(n,b,x,E)};return r.jsxs("div",{className:"app-container",children:[r.jsx(H,{cameraEnabled:e,isPlaying:h,isReading:u,isLoading:o,tangibleInstance:n,onCameraToggle:F,onPlayStop:N,onRead:k}),r.jsx(B,{cameraEnabled:e}),r.jsx(z,{cameraEnabled:e,codeText:t,textareaRef:y,soundSets:l,soundSetOptions:J,onCodeTextChange:i,onSoundSetChange:R})]})}function K({}){return[{title:"TIBBL"},{name:"description",content:"TIBBL web application"}]}const Q=P(function(){return r.jsx(G,{})});export{Q as default,K as meta};
