import{p as r,a as v,w as M}from"./chunk-EPOLDU6W-CP3WDhNt.js";function V({cameraEnabled:e,isPlaying:i,isReading:t,isLoading:a,tangibleInstance:s,onCameraToggle:o,onPlayStop:l,onRead:c}){return r.jsxs("header",{className:"header",role:"banner",children:[r.jsx("div",{className:"logo-container",children:r.jsx("img",{src:"https://armbennett.github.io/tangible-11ty/assets/img/tibbl-logo.png",alt:"Application logo",className:"logo"})}),r.jsxs("nav",{className:"header-buttons",role:"navigation","aria-label":"Main navigation",children:[r.jsxs("button",{className:"header-button",onClick:o,"aria-label":e?"Disable camera":"Enable camera","aria-pressed":e,disabled:a||!s,children:[r.jsx("i",{className:"fa-solid fa-camera fa-2xl","aria-hidden":"true"}),r.jsx("span",{children:"Camera"})]}),r.jsxs("button",{className:"header-button",onClick:l,"aria-label":i?"Stop code execution":"Play and execute code","aria-pressed":i,disabled:a||!s,children:[r.jsx("i",{className:`fa-solid ${i?"fa-stop":"fa-play"} fa-2xl`,"aria-hidden":"true"}),r.jsx("span",{children:i?"Stop":"Play"})]}),r.jsxs("button",{className:"header-button",onClick:c,"aria-label":t?"Stop reading code":"Read out code text","aria-pressed":t,disabled:a||!s,children:[r.jsx("i",{className:"fa-brands fa-readme fa-2xl","aria-hidden":"true"}),r.jsx("span",{children:t?"Stop":"Read"})]})]})]})}function z({cameraEnabled:e,rotation:i,onRotate:t}){const a=i===90||i===270;return r.jsxs(r.Fragment,{children:[e&&r.jsx("section",{className:"camera-section",role:"region","aria-label":"Camera view",children:r.jsxs("div",{className:"video-container",children:[r.jsx("canvas",{id:"video-canvas",width:"640",height:"480","aria-label":"Camera view and code tile detection overlay",className:a?"rotated-sideways":"",style:{transform:`rotate(${i}deg)`}}),r.jsx("button",{className:"rotate-button",onClick:t,"aria-label":`Rotate camera view 90 degrees clockwise (currently ${i} degrees)`,type:"button",children:r.jsx("i",{className:"fa-solid fa-rotate-right","aria-hidden":"true"})})]})}),!e&&r.jsx("canvas",{id:"video-canvas",width:"640",height:"480",style:{display:"none"}})]})}function H({threadNumber:e,value:i,onChange:t,soundSets:a}){const s=`thread${e}`,o=`Thread ${e}`;return r.jsxs("div",{className:"dropdown-group",children:[r.jsx("label",{htmlFor:s,className:"dropdown-label",children:o}),r.jsx("select",{id:s,className:"dropdown",value:i,onChange:l=>t(l.target.value),"aria-label":`Select ${o} sound options`,children:a.map(l=>r.jsx("option",{value:l.value,children:l.label},l.value))})]})}function U({cameraEnabled:e,codeText:i,textareaRef:t,soundSets:a,soundSetOptions:s,onCodeTextChange:o,onSoundSetChange:l}){return r.jsxs("section",{className:`output-section ${e?"camera-active":""}`,role:"region","aria-label":"Code output and thread selection",children:[r.jsx("div",{className:"textbox-container",children:r.jsx("textarea",{ref:t,value:i,onChange:c=>o(c.target.value),className:"output-textbox",placeholder:`Thread 1
Loop 4 times
Play 5
End loop
Play 7

Thread 2
Delay 4
Loop 3 times
Play 8
End loop`,"aria-label":"Code output text area"})}),r.jsxs("div",{className:"dropdown-container",children:[r.jsx(H,{threadNumber:1,value:a[0],onChange:c=>l(0,c),soundSets:s}),r.jsx(H,{threadNumber:2,value:a[1],onChange:c=>l(1,c),soundSets:s}),r.jsx(H,{threadNumber:3,value:a[2],onChange:c=>l(2,c),soundSets:s})]})]})}function O(e){v.useEffect(()=>{if(!e)return;const i=p=>{const x=p.detail.topcodes,h=document.getElementById("video-canvas-video"),f=document.getElementById("video-canvas");if(!h||!f||h.readyState<2)return;const n=f.getContext("2d");if(!n)return;const g=h.videoWidth,m=h.videoHeight,$=m>g;n.clearRect(0,0,f.width,f.height),n.drawImage(h,0,0,f.width,f.height),n.fillStyle="rgba(255, 0, 0, 0.3)",n.strokeStyle="rgba(255, 0, 0, 0.8)",n.lineWidth=2;for(let T=0;T<x.length;T++){const N=x[T],E=f.width-N.x,W=N.y;n.beginPath(),n.arc(E,W,N.radius,0,Math.PI*2),n.fill(),n.stroke(),n.fillStyle="rgba(255, 255, 255, 1)",n.font="14px monospace",n.textAlign="center",n.textBaseline="middle",n.fillText(`(${Math.round(E)}, ${Math.round(W)})`,E,W),n.fillStyle="rgba(255, 0, 0, 0.3)"}n.fillStyle="rgba(255, 0, 0, 0.7)",n.fillRect(0,0,100,44),n.fillStyle="rgba(255, 255, 255, 1)",n.font="bold 14px monospace",n.textAlign="left",n.textBaseline="middle",n.fillText($?"Portrait":"Landscape",5,10),n.fillText(`(${f.width} x ${f.height})`,5,30),n.fillStyle="rgba(0, 100, 0, 0.8)",n.fillRect(0,f.height-110,180,110),n.fillStyle="rgba(255, 255, 255, 1)",n.font="12px monospace",n.textAlign="left",n.textBaseline="top",n.fillText(`Video: ${g}x${m}`,5,f.height-105),n.fillText(`Canvas: ${f.width}x${f.height}`,5,f.height-90),n.fillText(`Aspect: ${(g/m).toFixed(2)}`,5,f.height-75),n.fillText(`TopCodes: ${x.length}`,5,f.height-60),n.fillText(`Browser: ${navigator.userAgent.includes("Safari")?"Safari":navigator.userAgent.includes("Chrome")?"Chrome":navigator.userAgent.includes("Firefox")?"Firefox":"Other"}`,5,f.height-45),n.fillText(`Platform: ${navigator.platform}`,5,f.height-30),n.fillText(`Ready: ${h.readyState}/4`,5,f.height-15)},t=()=>{const p=document.getElementById("video-canvas-video"),u=document.getElementById("video-canvas"),x=document.querySelector(".video-container");if(p&&u&&x){p.style.display="none";const h=p.videoWidth||640,f=p.videoHeight||480,n=f>h;let g,m;n?(g=h,m=f,console.log(`Portrait mode detected: Using video dimensions ${g}x${m}`)):(g=640,m=480,console.log(`Landscape mode detected: Using fixed dimensions ${g}x${m}`)),(u.width!==g||u.height!==m)&&(u.width=g,u.height=m,console.log(`Canvas resized to ${g}x${m}`)),x.contains(u)||x.appendChild(u);const $=u.classList.contains("rotated-sideways");u.style.display="block",u.style.position="relative",u.style.objectFit="contain",$?(u.style.width="auto",u.style.height="auto",u.style.maxWidth="50vh",u.style.maxHeight="none"):(u.style.width="100%",u.style.height="auto",u.style.maxHeight="50vh",u.style.maxWidth="")}},a=document.getElementById("video-canvas-video"),s=()=>{a&&(console.log(`Video metadata loaded: ${a.videoWidth}x${a.videoHeight}`),t())};a&&(a.readyState>=1&&t(),a.addEventListener("loadedmetadata",s));const o=setInterval(()=>{const p=document.getElementById("video-canvas-video");p&&p.readyState>=1&&(t(),clearInterval(o))},100),l=setTimeout(()=>clearInterval(o),5e3);window.addEventListener("topcodes-detected",i);const c=document.getElementById("video-canvas");let d=null;return c&&(d=new MutationObserver(()=>{t()}),d.observe(c,{attributes:!0,attributeFilter:["class"]})),()=>{clearInterval(o),clearTimeout(l),window.removeEventListener("topcodes-detected",i),a&&a.removeEventListener("loadedmetadata",s),d&&d.disconnect()}},[e])}function D(e,i,t){v.useEffect(()=>{if(!e)return;const a=setInterval(()=>{i&&!e.synthesis.speaking&&t(!1)},100);return()=>clearInterval(a)},[e,i,t])}async function _(e,i){const a=await(await fetch(`${e}/assets/js/howler.js`)).text(),s=document.createElement("script");s.textContent=a,document.head.appendChild(s);const l=await(await fetch(`${e}/assets/js/topcodes.js`)).text(),c=document.createElement("script");c.textContent=l,document.head.appendChild(c);let u=(await(await fetch(`${e}/assets/js/tangible.js`)).text()).replace("export default class Tangible","window.Tangible = class Tangible");u=u.replace(/setupTangible\(\) \{[\s\S]*?setVideoFrameCallback\("video-canvas", function \(jsonString\) \{[\s\S]*?\}, this\);[\s\S]*?\}/,`setupTangible() {
        this.setVideoCanvasHeight('video-canvas');
        let tangible = this;
        
        TopCodes.setVideoFrameCallback("video-canvas", function (jsonString) {
            var json = JSON.parse(jsonString);
            var topcodes = json.topcodes;
            tangible.currentCodes = topcodes;
            tangible.once = true;
            
            const event = new CustomEvent('topcodes-detected', { 
                detail: { topcodes: topcodes } 
            });
            window.dispatchEvent(event);
        }, this);
    }`);const x=document.createElement("script");if(x.textContent=u,document.head.appendChild(x),await new Promise(h=>setTimeout(h,200)),window.Tangible){const h=new window.Tangible;return h.setupTangible(),i(h,"Numbers",0),i(h,"Notifications",1),i(h,"Notifications",2),h}else return console.error("window.Tangible not available"),null}function J(e,i,t,a){v.useEffect(()=>{(async()=>{try{const o=await _(e,a);i(o),t(!1)}catch(o){console.error("Error loading scripts:",o),t(!1)}})()},[e,i,t,a])}let S=!1,b=[];function X(e,i,t,a){v.useEffect(()=>{const s=o=>{o.touches.length===3&&(o.preventDefault(),S&&(b.forEach(l=>clearTimeout(l)),b=[],t&&t.synthesis.cancel(),S=!1),i&&t?(S=!0,(async()=>{t.readCode("3");const c=setTimeout(async()=>{if(!S)return;t.readCode("2");const d=setTimeout(async()=>{if(!S)return;t.readCode("1");const p=setTimeout(()=>{S&&(S=!1,b=[],e())},1e3);b.push(p)},1e3);b.push(d)},1e3);b.push(c)})()):e())};return document.addEventListener("touchstart",s,{passive:!1}),()=>{document.removeEventListener("touchstart",s),b.forEach(o=>clearTimeout(o)),b=[],S=!1}},a)}function B(e){return e.replace(/<br\/>/g,`
`).replace(/,\s*X:\[object Object\]/g,"").toLowerCase().replace(/(^|\n)([a-z])/g,(i,t,a)=>t+a.toUpperCase()).replace(/x/g,"X")}function k(e){const i=e.split(`
`).map(s=>s.trim().toLowerCase()),t=[];let a=!1;for(let s=0;s<i.length;s++){const o=i[s];if(o.startsWith("loop"))t.push({type:"loop",index:s+1});else if(o.startsWith("end loop")||o.startsWith("endloop")){if(t.length===0||t[t.length-1].type!=="loop")return{valid:!1,error:`Unexpected end loop at position ${s+1}`};t.pop()}else if(o.startsWith("if"))t.push({type:"if",index:s+1});else if(o.startsWith("end if")||o.startsWith("endif")){if(t.length===0||t[t.length-1].type!=="if")return{valid:!1,error:`Unexpected end if at position ${s+1}`};t.pop()}else if(o.startsWith("function"))t.push({type:"function",index:s+1});else if(o.startsWith("end function")||o.startsWith("endfunction")){if(t.length===0||t[t.length-1].type!=="function")return{valid:!1,error:`Unexpected end function at position ${s+1}`};t.pop()}else if(o.startsWith("x =")||o.startsWith("x="))a=!0;else if((o.startsWith("play x")||o.startsWith("if x"))&&!a)return{valid:!1,error:`Variable used at ${s+1} without being set.`}}if(t.length>0){const s=t[t.length-1];return{valid:!1,error:`Missing end tile for ${s.type} in position ${s.index}.`}}return{valid:!0}}let C=!1,y=null;function G(e,i,t,a,s,o){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(y&&(clearInterval(y),y=null),e.isAudioPlaying()||C){e.stopAllSounds(),o(!1),C=!1;return}if(C=!0,i){const c=e.scanCode();if(c){const d=B(c);s(d);const p=k(d);if(!p.valid&&p.error){e.readCode(p.error),C=!1;return}d&&d.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(d),o(!0),y=setInterval(()=>{e.isAudioPlaying()||(o(!1),C=!1,y&&(clearInterval(y),y=null))},100)):C=!1;return}C=!1}const l=a.current?.value||t;if(l&&l.trim()){const c=k(l);if(!c.valid&&c.error){e.readCode(c.error),C=!1;return}}l&&l.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(l),o(!0),y=setInterval(()=>{e.isAudioPlaying()||(o(!1),C=!1,y&&(clearInterval(y),y=null))},100)):(e.readCode("No code to run."),C=!1)}}let j=!1;function q(e,i,t,a,s,o){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(e.synthesis.speaking||j){e.synthesis.cancel(),o(!1),j=!1;return}if(e.isAudioPlaying()){e.stopAllSounds();return}if(j=!0,i){const c=e.scanCode();if(c){const d=B(c);s(d),d&&d.trim()?(e.readCode(d),o(!0)):j=!1;return}j=!1}const l=a.current?.value||t;l&&l.trim()?(e.readCode(l),o(!0)):(e.readCode("No code to read."),j=!1)}}function A(e,i,t,a){const s=new window.Howl({src:[`${a}/assets/sound/${i}.mp3`],volume:.2,sprite:e.soundSets[i]});e.threads[t]=s}const P="https://raw.githubusercontent.com/armbennett/tangible-11ty/main",Y=[{value:"Numbers",label:"Numbers"},{value:"MusicLoops1",label:"Music Loops 1"},{value:"Mystery",label:"Mystery"},{value:"Notifications",label:"Notifications"},{value:"OdeToJoy",label:"Ode to Joy"},{value:"FurElise",label:"Fur Elise"}];function K(){const[e,i]=v.useState(!1),[t,a]=v.useState(""),[s,o]=v.useState(!0),[l,c]=v.useState(["Numbers","Notifications","Notifications"]),[d,p]=v.useState(null),[u,x]=v.useState(!1),[h,f]=v.useState(!1),[n,g]=v.useState(0),m=v.useRef(null),$=v.useCallback((w,R,L)=>{A(w,R,L,P)},[]);O(e),D(d,u,x),J(P,p,o,$);const T=G(d,e,t,m,a,f),N=q(d,e,t,m,a,x);X(T,e,d,[d,e,t]);const E=()=>{if(!d){console.error("Tangible instance not initialized");return}const w=!e;d.cameraStatus=w,window.TopCodes&&(window.TopCodes.startStopVideoScan("video-canvas",d.mode),w||setTimeout(()=>{delete window.TopCodes._mediaStreams["video-canvas"]},100)),i(w)},W=()=>{g(w=>(w+90)%360)},F=(w,R)=>{const L=[...l];L[w]=R,c(L),d&&A(d,R,w,P)};return r.jsxs("div",{className:"app-container",children:[r.jsx(V,{cameraEnabled:e,isPlaying:h,isReading:u,isLoading:s,tangibleInstance:d,onCameraToggle:E,onPlayStop:T,onRead:N}),r.jsx(z,{cameraEnabled:e,rotation:n,onRotate:W}),r.jsx(U,{cameraEnabled:e,codeText:t,textareaRef:m,soundSets:l,soundSetOptions:Y,onCodeTextChange:a,onSoundSetChange:F})]})}function Z({}){return[{title:"TIBBL"},{name:"description",content:"TIBBL web application"}]}const I=M(function(){return r.jsx(K,{})});export{I as default,Z as meta};
