import{p as r,a as p,w as z}from"./chunk-EPOLDU6W-CP3WDhNt.js";function B({cameraEnabled:e,isPlaying:n,isReading:t,isLoading:i,tangibleInstance:a,onCameraToggle:s,onPlayStop:l,onRead:u}){return r.jsxs("header",{className:"header",role:"banner",children:[r.jsx("div",{className:"logo-container",children:r.jsx("img",{src:"https://armbennett.github.io/tangible-11ty/assets/img/tibbl-logo.png",alt:"Application logo",className:"logo"})}),r.jsxs("nav",{className:"header-buttons",role:"navigation","aria-label":"Main navigation",children:[r.jsxs("button",{className:"header-button",onClick:s,"aria-label":e?"Disable camera":"Enable camera","aria-pressed":e,disabled:i||!a,children:[r.jsx("i",{className:"fa-solid fa-camera fa-2xl","aria-hidden":"true"}),r.jsx("span",{children:"Camera"})]}),r.jsxs("button",{className:"header-button",onClick:l,"aria-label":n?"Stop code execution":"Play and execute code","aria-pressed":n,disabled:i||!a,children:[r.jsx("i",{className:`fa-solid ${n?"fa-stop":"fa-play"} fa-2xl`,"aria-hidden":"true"}),r.jsx("span",{children:n?"Stop":"Play"})]}),r.jsxs("button",{className:"header-button",onClick:u,"aria-label":t?"Stop reading code":"Read out code text","aria-pressed":t,disabled:i||!a,children:[r.jsx("i",{className:"fa-brands fa-readme fa-2xl","aria-hidden":"true"}),r.jsx("span",{children:t?"Stop":"Read"})]})]})]})}function P({cameraEnabled:e}){return r.jsxs(r.Fragment,{children:[e&&r.jsx("section",{className:"camera-section",role:"region","aria-label":"Camera view",children:r.jsx("div",{className:"video-container",children:r.jsx("canvas",{id:"video-canvas",width:"640",height:"480","aria-label":"Code tile detection overlay"})})}),!e&&r.jsx("canvas",{id:"video-canvas",width:"640",height:"480",style:{display:"none"}})]})}function W({threadNumber:e,value:n,onChange:t,soundSets:i}){const a=`thread${e}`,s=`Thread ${e}`;return r.jsxs("div",{className:"dropdown-group",children:[r.jsx("label",{htmlFor:a,className:"dropdown-label",children:s}),r.jsx("select",{id:a,className:"dropdown",value:n,onChange:l=>t(l.target.value),"aria-label":`Select ${s} sound options`,children:i.map(l=>r.jsx("option",{value:l.value,children:l.label},l.value))})]})}function H({cameraEnabled:e,codeText:n,textareaRef:t,soundSets:i,soundSetOptions:a,onCodeTextChange:s,onSoundSetChange:l}){return r.jsxs("section",{className:`output-section ${e?"camera-active":""}`,role:"region","aria-label":"Code output and thread selection",children:[r.jsx("div",{className:"textbox-container",children:r.jsx("textarea",{ref:t,value:n,onChange:u=>s(u.target.value),className:"output-textbox",placeholder:`Thread 1
Loop 4 times
Play 5
End loop
Play 7

Thread 2
Delay 4
Loop 3 times
Play 8
End loop`,"aria-label":"Code output text area"})}),r.jsxs("div",{className:"dropdown-container",children:[r.jsx(W,{threadNumber:1,value:i[0],onChange:u=>l(0,u),soundSets:a}),r.jsx(W,{threadNumber:2,value:i[1],onChange:u=>l(1,u),soundSets:a}),r.jsx(W,{threadNumber:3,value:i[2],onChange:u=>l(2,u),soundSets:a})]})]})}function M(e){p.useEffect(()=>{if(!e)return;let n=null,t=[];const i=()=>{const o=document.getElementById("video-canvas-video"),d=document.getElementById("video-canvas");if(!o||!d){n=requestAnimationFrame(i);return}const c=d.getContext("2d");if(!c){n=requestAnimationFrame(i);return}c.clearRect(0,0,d.width,d.height),o.videoWidth,o.videoHeight;const h=d.width,f=d.height,g=h/640,S=f/480;c.fillStyle="rgba(255, 0, 0, 0.3)",c.strokeStyle="rgba(255, 0, 0, 0.8)",c.lineWidth=2;for(let j=0;j<t.length;j++){const y=t[j],T=y.x*g,E=y.y*S,$=y.radius*Math.min(g,S);c.beginPath(),c.arc(T,E,$,0,Math.PI*2),c.fill(),c.stroke(),c.fillStyle="rgba(255, 255, 255, 0.9)",c.font="20px Arial",c.textAlign="center",c.textBaseline="middle",c.fillText(y.code.toString(),T,E),c.fillStyle="rgba(255, 0, 0, 0.3)"}n=requestAnimationFrame(i)},a=o=>{t=o.detail.topcodes},s=()=>{const o=document.getElementById("video-canvas-video"),d=document.getElementById("video-canvas"),c=document.querySelector(".video-container");if(o&&d&&c){c.contains(o)||c.insertBefore(o,c.firstChild),o.style.display="block",o.style.width="100%",o.style.height="100%",o.style.objectFit="cover",c.contains(d)||c.appendChild(d),d.style.display="block",d.style.position="absolute",d.style.top="0",d.style.left="0",d.style.width="100%",d.style.height="100%",d.style.pointerEvents="none",d.style.zIndex="10";const h=()=>{const g=o.getBoundingClientRect();d.width=g.width,d.height=g.height},f=()=>{h(),n||i()};return o.addEventListener("loadedmetadata",f),o.addEventListener("playing",f),window.addEventListener("resize",h),o.readyState>=2&&f(),()=>{o.removeEventListener("loadedmetadata",f),o.removeEventListener("playing",f),window.removeEventListener("resize",h)}}},l=setInterval(()=>{document.getElementById("video-canvas-video")&&(s(),clearInterval(l))},100),u=setTimeout(()=>clearInterval(l),5e3);return window.addEventListener("topcodes-detected",a),()=>{clearInterval(l),clearTimeout(u),window.removeEventListener("topcodes-detected",a),n&&cancelAnimationFrame(n)}},[e])}function V(e,n,t){p.useEffect(()=>{if(!e)return;const i=setInterval(()=>{n&&!e.synthesis.speaking&&t(!1)},100);return()=>clearInterval(i)},[e,n,t])}async function D(e,n){const i=await(await fetch(`${e}/assets/js/howler.js`)).text(),a=document.createElement("script");a.textContent=i,document.head.appendChild(a);const l=await(await fetch(`${e}/assets/js/topcodes.js`)).text(),u=document.createElement("script");u.textContent=l,document.head.appendChild(u);let c=(await(await fetch(`${e}/assets/js/tangible.js`)).text()).replace("export default class Tangible","window.Tangible = class Tangible");c=c.replace(/setupTangible\(\) \{[\s\S]*?setVideoFrameCallback\("video-canvas", function \(jsonString\) \{[\s\S]*?\}, this\);[\s\S]*?\}/,`setupTangible() {
        this.setVideoCanvasHeight('video-canvas');
        let tangible = this;
        
        TopCodes.setVideoFrameCallback("video-canvas", function (jsonString) {
            var json = JSON.parse(jsonString);
            var topcodes = json.topcodes;
            tangible.currentCodes = topcodes;
            tangible.once = true;
            
            const event = new CustomEvent('topcodes-detected', { 
                detail: { topcodes: topcodes } 
            });
            window.dispatchEvent(event);
        }, this);
    }`);const h=document.createElement("script");if(h.textContent=c,document.head.appendChild(h),await new Promise(f=>setTimeout(f,200)),window.Tangible){const f=new window.Tangible;return f.setupTangible(),n(f,"Numbers",0),n(f,"Notifications",1),n(f,"Notifications",2),f}else return console.error("window.Tangible not available"),null}function O(e,n,t,i){p.useEffect(()=>{(async()=>{try{const s=await D(e,i);n(s),t(!1)}catch(s){console.error("Error loading scripts:",s),t(!1)}})()},[e,n,t,i])}let C=!1,w=[];function U(e,n,t,i){p.useEffect(()=>{const a=s=>{s.touches.length===3&&(s.preventDefault(),C&&(w.forEach(l=>clearTimeout(l)),w=[],t&&t.synthesis.cancel(),C=!1),n&&t?(C=!0,(async()=>{t.readCode("3");const u=setTimeout(async()=>{if(!C)return;t.readCode("2");const o=setTimeout(async()=>{if(!C)return;t.readCode("1");const d=setTimeout(()=>{C&&(C=!1,w=[],e())},1e3);w.push(d)},1e3);w.push(o)},1e3);w.push(u)})()):e())};return document.addEventListener("touchstart",a,{passive:!1}),()=>{document.removeEventListener("touchstart",a),w.forEach(s=>clearTimeout(s)),w=[],C=!1}},i)}function F(e){return e.replace(/<br\/>/g,`
`).replace(/,\s*X:\[object Object\]/g,"").toLowerCase().replace(/(^|\n)([a-z])/g,(n,t,i)=>t+i.toUpperCase()).replace(/x/g,"X")}function A(e){const n=e.split(`
`).map(a=>a.trim().toLowerCase()),t=[];let i=!1;for(let a=0;a<n.length;a++){const s=n[a];if(s.startsWith("loop"))t.push({type:"loop",index:a+1});else if(s.startsWith("end loop")||s.startsWith("endloop")){if(t.length===0||t[t.length-1].type!=="loop")return{valid:!1,error:`Unexpected end loop at position ${a+1}`};t.pop()}else if(s.startsWith("if"))t.push({type:"if",index:a+1});else if(s.startsWith("end if")||s.startsWith("endif")){if(t.length===0||t[t.length-1].type!=="if")return{valid:!1,error:`Unexpected end if at position ${a+1}`};t.pop()}else if(s.startsWith("function"))t.push({type:"function",index:a+1});else if(s.startsWith("end function")||s.startsWith("endfunction")){if(t.length===0||t[t.length-1].type!=="function")return{valid:!1,error:`Unexpected end function at position ${a+1}`};t.pop()}else if(s.startsWith("x =")||s.startsWith("x="))i=!0;else if((s.startsWith("play x")||s.startsWith("if x"))&&!i)return{valid:!1,error:`Variable used at ${a+1} without being set.`}}if(t.length>0){const a=t[t.length-1];return{valid:!1,error:`Missing end tile for ${a.type} in position ${a.index}.`}}return{valid:!0}}let v=!1,m=null;function q(e,n,t,i,a,s){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(m&&(clearInterval(m),m=null),e.isAudioPlaying()||v){e.stopAllSounds(),s(!1),v=!1;return}if(v=!0,n){const u=e.scanCode();if(u){const o=F(u);a(o);const d=A(o);if(!d.valid&&d.error){e.readCode(d.error),v=!1;return}o&&o.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(o),s(!0),m=setInterval(()=>{e.isAudioPlaying()||(s(!1),v=!1,m&&(clearInterval(m),m=null))},100)):v=!1;return}v=!1}const l=i.current?.value||t;if(l&&l.trim()){const u=A(l);if(!u.valid&&u.error){e.readCode(u.error),v=!1;return}}l&&l.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(l),s(!0),m=setInterval(()=>{e.isAudioPlaying()||(s(!1),v=!1,m&&(clearInterval(m),m=null))},100)):(e.readCode("No code to run."),v=!1)}}let b=!1;function X(e,n,t,i,a,s){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(e.synthesis.speaking||b){e.synthesis.cancel(),s(!1),b=!1;return}if(e.isAudioPlaying()){e.stopAllSounds();return}if(b=!0,n){const u=e.scanCode();if(u){const o=F(u);a(o),o&&o.trim()?(e.readCode(o),s(!0)):b=!1;return}b=!1}const l=i.current?.value||t;l&&l.trim()?(e.readCode(l),s(!0)):(e.readCode("No code to read."),b=!1)}}function R(e,n,t,i){const a=new window.Howl({src:[`${i}/assets/sound/${n}.mp3`],volume:.2,sprite:e.soundSets[n]});e.threads[t]=a}const k="https://raw.githubusercontent.com/armbennett/tangible-11ty/main",_=[{value:"Numbers",label:"Numbers"},{value:"MusicLoops1",label:"Music Loops 1"},{value:"Mystery",label:"Mystery"},{value:"Notifications",label:"Notifications"},{value:"OdeToJoy",label:"Ode to Joy"},{value:"FurElise",label:"Fur Elise"}];function J(){const[e,n]=p.useState(!1),[t,i]=p.useState(""),[a,s]=p.useState(!0),[l,u]=p.useState(["Numbers","Notifications","Notifications"]),[o,d]=p.useState(null),[c,h]=p.useState(!1),[f,g]=p.useState(!1),S=p.useRef(null),j=p.useCallback((x,N,L)=>{R(x,N,L,k)},[]);M(e),V(o,c,h),O(k,d,s,j);const y=q(o,e,t,S,i,g),T=X(o,e,t,S,i,h);U(y,e,o,[o,e,t]);const E=()=>{if(!o){console.error("Tangible instance not initialized");return}const x=!e;o.cameraStatus=x,window.TopCodes&&(window.TopCodes.startStopVideoScan("video-canvas",o.mode),x||setTimeout(()=>{delete window.TopCodes._mediaStreams["video-canvas"]},100)),n(x)},$=(x,N)=>{const L=[...l];L[x]=N,u(L),o&&R(o,N,x,k)};return r.jsxs("div",{className:"app-container",children:[r.jsx(B,{cameraEnabled:e,isPlaying:f,isReading:c,isLoading:a,tangibleInstance:o,onCameraToggle:E,onPlayStop:y,onRead:T}),r.jsx(P,{cameraEnabled:e}),r.jsx(H,{cameraEnabled:e,codeText:t,textareaRef:S,soundSets:l,soundSetOptions:_,onCodeTextChange:i,onSoundSetChange:$})]})}function Y({}){return[{title:"TIBBL"},{name:"description",content:"TIBBL web application"}]}const K=z(function(){return r.jsx(J,{})});export{K as default,Y as meta};
