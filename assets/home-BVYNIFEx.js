import{p as l,a as v,w as Z}from"./chunk-EPOLDU6W-CP3WDhNt.js";function q({cameraEnabled:e,isPlaying:a,isReading:o,isLoading:s,tangibleInstance:n,onCameraToggle:t,onPlayStop:i,onRead:h}){return l.jsxs("header",{className:"header",role:"banner",children:[l.jsx("div",{className:"logo-container","aria-hidden":"true",children:l.jsx("img",{src:"https://armbennett.github.io/tangible-11ty/assets/img/tibbl-logo.png",alt:"Application logo",className:"logo"})}),l.jsxs("nav",{className:"header-buttons",role:"navigation","aria-label":"Main navigation",children:[l.jsxs("button",{className:"header-button",onClick:t,"aria-label":e?"Disable camera":"Enable camera","aria-pressed":e,disabled:s||!n,children:[l.jsx("i",{className:"fa-solid fa-camera fa-2xl","aria-hidden":"true"}),l.jsx("span",{children:"Camera"})]}),l.jsxs("button",{className:"header-button",onClick:i,"aria-label":a?"Stop code execution":"Play and execute code","aria-pressed":a,disabled:s||!n,children:[l.jsx("i",{className:`fa-solid ${a?"fa-stop":"fa-play"} fa-2xl`,"aria-hidden":"true"}),l.jsx("span",{children:a?"Stop":"Play"})]}),l.jsxs("button",{className:"header-button",onClick:h,"aria-label":o?"Stop reading code":"Read out code text","aria-pressed":o,disabled:s||!n,children:[l.jsx("i",{className:"fa-brands fa-readme fa-2xl","aria-hidden":"true"}),l.jsx("span",{children:o?"Stop":"Read"})]})]})]})}function K({cameraEnabled:e,rotation:a,readingOrderRotation:o,onRotate:s,onReadingOrderRotate:n}){const t=a===90||a===270;return l.jsxs(l.Fragment,{children:[e&&l.jsx("section",{className:"camera-section",role:"region","aria-label":"Camera view",children:l.jsxs("div",{className:"video-container",children:[l.jsx("canvas",{id:"video-canvas",width:"640",height:"480","aria-label":"Camera view and code tile detection overlay",className:t?"rotated-sideways":"",style:{transform:`rotate(${a}deg)`}}),l.jsx("button",{className:"rotate-button",onClick:s,"aria-label":`Rotate camera view 90 degrees clockwise (currently ${a} degrees)`,type:"button",children:l.jsx("i",{className:"fa-solid fa-camera-rotate","aria-hidden":"true"})}),l.jsx("button",{className:"reading-order-button",onClick:n,"aria-label":`Rotate reading order 90 degrees clockwise (currently ${o} degrees)`,type:"button",children:l.jsx("i",{className:"fa-solid fa-rotate-right","aria-hidden":"true"})})]})}),!e&&l.jsx("canvas",{id:"video-canvas",width:"640",height:"480",style:{display:"none"}})]})}function B({threadNumber:e,value:a,onChange:o,soundSets:s}){const n=`thread${e}`,t=`Thread ${e}`;return l.jsxs("div",{className:"dropdown-group",children:[l.jsx("label",{htmlFor:n,className:"dropdown-label",children:t}),l.jsx("select",{id:n,className:"dropdown",value:a,onChange:i=>o(i.target.value),"aria-label":`Select ${t} sound options`,children:s.map(i=>l.jsx("option",{value:i.value,children:i.label},i.value))})]})}function ee({cameraEnabled:e,codeText:a,textareaRef:o,soundSets:s,soundSetOptions:n,onCodeTextChange:t,onSoundSetChange:i,placeholder:h}){return l.jsxs("section",{className:`output-section ${e?"camera-active":""}`,role:"region","aria-label":"Code output and thread selection",children:[l.jsx("div",{className:"textbox-container",children:l.jsx("textarea",{ref:o,value:a,onChange:r=>t(r.target.value),className:"output-textbox",placeholder:h,"aria-label":"Code output text area"})}),l.jsxs("div",{className:"dropdown-container",children:[l.jsx(B,{threadNumber:1,value:s[0],onChange:r=>i(0,r),soundSets:n}),l.jsx(B,{threadNumber:2,value:s[1],onChange:r=>i(1,r),soundSets:n}),l.jsx(B,{threadNumber:3,value:s[2],onChange:r=>i(2,r),soundSets:n})]})]})}function te(e,a){return Math.abs(e.y-a.y)<=40?e.x==a.x?0:e.x<a.x?1:-1:e.y<a.y?-1:1}function oe(e){e.sort(te);let a=[],o=Array(),s=-1;for(let n=0;n<e.length;n++)s>=0&&e[n].y-s>=40?(a.push(o),o=Array(),s=e[n].y):s<0&&(s=e[n].y),o.push(e[n]);return a.push(o),a}function se(e,a){const o=[];switch(a){case 0:for(let t=0;t<e.length;t++)for(let i=0;i<e[t].length;i++)o.push(e[t][i]);break;case 90:const s=Math.max(...e.map(t=>t.length));for(let t=s-1;t>=0;t--)for(let i=0;i<e.length;i++)t<e[i].length&&o.push(e[i][t]);break;case 180:for(let t=e.length-1;t>=0;t--)for(let i=e[t].length-1;i>=0;i--)o.push(e[t][i]);break;case 270:const n=Math.max(...e.map(t=>t.length));for(let t=0;t<n;t++)for(let i=e.length-1;i>=0;i--)t<e[i].length&&o.push(e[i][t]);break;default:for(let t=0;t<e.length;t++)for(let i=0;i<e[t].length;i++)o.push(e[t][i])}return o}function X(e,a){const o=oe([...e]);return se(o,a)}function ne(e,a){v.useEffect(()=>{if(!e)return;const o=d=>{const A=X(d.detail.topcodes,a),T=document.getElementById("video-canvas-video"),f=document.getElementById("video-canvas");if(!T||!f||T.readyState<2)return;const u=f.getContext("2d");if(!u)return;const b=T.videoWidth,j=T.videoHeight,D=j>b;let S,H;D?(S=b,H=j):(S=640,H=480),(f.width!==S||f.height!==H)&&(f.width=S,f.height=H),u.clearRect(0,0,f.width,f.height),u.drawImage(T,0,0,f.width,f.height),u.fillStyle="#00640080",u.strokeStyle="#006400",u.lineWidth=5;for(let O=0;O<A.length;O++){const P=A[O],F=f.width-P.x,W=P.y;u.beginPath(),u.arc(F,W,P.radius,0,Math.PI*2),u.fill(),u.stroke(),u.fillStyle="rgba(255, 255, 255, 1)",u.font="900 28px monospace",u.save(),u.translate(F,W),u.rotate(a*(Math.PI/180)),u.textAlign="center",u.textBaseline="middle",u.fillText(`${O+1}`,0,0),u.restore(),u.fillStyle="#00640080"}},s=()=>{const d=document.getElementById("video-canvas-video"),c=document.getElementById("video-canvas"),A=document.querySelector(".video-container");if(d&&c&&A){d.style.display="none";const T=d.videoWidth||640,f=d.videoHeight||480,u=f>T;let b,j;u?(b=T,j=f):(b=640,j=480),(c.width!==b||c.height!==j)&&(c.width=b,c.height=j),A.contains(c)||A.appendChild(c);const D=c.classList.contains("rotated-sideways");c.style.display="block",c.style.position="relative",c.style.objectFit="contain",D?(c.style.width="auto",c.style.height="auto",c.style.maxWidth="50vh",c.style.maxHeight="none"):(c.style.width="100%",c.style.height="auto",c.style.maxHeight="50vh",c.style.maxWidth="")}},n=document.getElementById("video-canvas-video"),t=()=>{n&&s()},i=()=>{s()};n&&(n.readyState>=1&&s(),n.addEventListener("loadedmetadata",t),n.addEventListener("resize",i));const h=()=>{setTimeout(()=>{s()},100)};window.addEventListener("orientationchange",h),window.addEventListener("resize",h);const r=setInterval(()=>{const d=document.getElementById("video-canvas-video");d&&d.readyState>=1&&(s(),clearInterval(r))},100),p=setTimeout(()=>clearInterval(r),5e3);window.addEventListener("topcodes-detected",o);const w=document.getElementById("video-canvas");let m=null;return w&&(m=new MutationObserver(()=>{s()}),m.observe(w,{attributes:!0,attributeFilter:["class"]})),()=>{clearInterval(r),clearTimeout(p),window.removeEventListener("topcodes-detected",o),window.removeEventListener("orientationchange",h),window.removeEventListener("resize",h),n&&(n.removeEventListener("loadedmetadata",t),n.removeEventListener("resize",i)),m&&m.disconnect()}},[e,a])}function ie(e,a,o){v.useEffect(()=>{if(!e)return;const s=setInterval(()=>{a&&!e.synthesis.speaking&&o(!1)},100);return()=>clearInterval(s)},[e,a,o])}async function ae(e,a){const s=await(await fetch(`${e}/assets/js/howler.js`)).text(),n=document.createElement("script");n.textContent=s,document.head.appendChild(n);const i=await(await fetch(`${e}/assets/js/topcodes.js`)).text(),h=document.createElement("script");h.textContent=i,document.head.appendChild(h);let w=(await(await fetch(`${e}/assets/js/tangible.js`)).text()).replace("export default class Tangible","window.Tangible = class Tangible");w=w.replace(/setupTangible\(\) \{[\s\S]*?setVideoFrameCallback\("video-canvas", function \(jsonString\) \{[\s\S]*?\}, this\);[\s\S]*?\}/,`setupTangible() {
        this.setVideoCanvasHeight('video-canvas');
        let tangible = this;
        
        TopCodes.setVideoFrameCallback("video-canvas", function (jsonString) {
            var json = JSON.parse(jsonString);
            var topcodes = json.topcodes;
            tangible.currentCodes = topcodes;
            tangible.once = true;
            
            const event = new CustomEvent('topcodes-detected', { 
                detail: { topcodes: topcodes } 
            });
            window.dispatchEvent(event);
        }, this);
    }`);const m=document.createElement("script");if(m.textContent=w,document.head.appendChild(m),await new Promise(d=>setTimeout(d,200)),window.Tangible){const d=new window.Tangible;return d.setupTangible(),a(d,"Numbers",0),a(d,"Notifications",1),a(d,"Notifications",2),d}else return console.error("window.Tangible not available"),null}function re(e,a,o,s){v.useEffect(()=>{(async()=>{try{const t=await ae(e,s);a(t),o(!1)}catch(t){console.error("Error loading scripts:",t),o(!1)}})()},[e,a,o,s])}let L=!1,R=[],C=null;function G(e){L&&(R.forEach(a=>clearTimeout(a)),R=[],C&&(C.stop(),C=null),e&&e.synthesis.cancel(),L=!1)}function le(e,a,o,s,n){v.useEffect(()=>{const t=i=>{i.touches.length===3&&(i.preventDefault(),G(o),a&&o?(L=!0,(async()=>{C||(C=new window.Howl({src:[`${s}/assets/sound/Numbers.mp3`],volume:1,sprite:o.soundSets.Numbers})),C.play("3");const r=setTimeout(()=>{if(!L)return;C?.play("2");const p=setTimeout(()=>{if(!L)return;C?.play("1");const w=setTimeout(()=>{L&&(L=!1,R=[],C&&(C=null),e())},1e3);R.push(w)},1e3);R.push(p)},1e3);R.push(r)})()):e())};return document.addEventListener("touchstart",t,{passive:!1}),()=>{document.removeEventListener("touchstart",t),R.forEach(i=>clearTimeout(i)),R=[],C&&(C.stop(),C=null),L=!1}},n)}function I(e){return e.replace(/<br\/>/g,`
`).replace(/,\s*X:\[object Object\]/g,"").toLowerCase().replace(/(^|\n)([a-z])/g,(a,o,s)=>o+s.toUpperCase()).replace(/x/g,"X")}function Y(e){const a=e.split(`
`).map(n=>n.trim().toLowerCase()),o=[];let s=!1;for(let n=0;n<a.length;n++){const t=a[n];if(t.startsWith("loop"))o.push({type:"loop",index:n+1});else if(t.startsWith("end loop")||t.startsWith("endloop")){if(o.length===0||o[o.length-1].type!=="loop")return{valid:!1,error:`Unexpected end loop at position ${n+1}`};o.pop()}else if(t.startsWith("if"))o.push({type:"if",index:n+1});else if(t.startsWith("end if")||t.startsWith("endif")){if(o.length===0||o[o.length-1].type!=="if")return{valid:!1,error:`Unexpected end if at position ${n+1}`};o.pop()}else if(t.startsWith("function"))o.push({type:"function",index:n+1});else if(t.startsWith("end function")||t.startsWith("endfunction")){if(o.length===0||o[o.length-1].type!=="function")return{valid:!1,error:`Unexpected end function at position ${n+1}`};o.pop()}else if(t.startsWith("x =")||t.startsWith("x="))s=!0;else if((t.startsWith("play x")||t.startsWith("if x"))&&!s)return{valid:!1,error:`Variable used at ${n+1} without being set.`}}if(o.length>0){const n=o[o.length-1];return{valid:!1,error:`Missing end tile for ${n.type} in position ${n.index}.`}}return{valid:!0}}function k(e){return e<.43?"5":e<1.4?"4":e<1.98?"3":e<2.85?"2":e<3.62?"1":e<4.3?"8":e<5.07?"7":"6"}function _(e,a,o){const s=[];for(const n of e){const t=a[n.code];if(t)if(t===o.LOOP){const i=k(n.angle);s.push(`LOOP ${i} TIMES`)}else if(t===o.PLAY){const i=k(n.angle);s.push(`PLAY ${i}`)}else if(t===o.DELAY){const i=k(n.angle);s.push(`DELAY ${i}`)}else if(t===o.IF){const i=k(n.angle);s.push(`IF X < ${i}`)}else if(t===o.VARIABLE){const i=k(n.angle);s.push(`X = ${i}`)}else t===o.ENDLOOP?s.push("END LOOP"):t===o.PLAYX?s.push("PLAY X"):t===o.THREAD1?s.push("THREAD 1"):t===o.THREAD2?s.push("THREAD 2"):t===o.THREAD3?s.push("THREAD 3"):t===o.FUNCTION?s.push("FUNCTION"):t===o.ENDFUNCTION?s.push("END FUNCTION"):t===o.FUNCTIONCALL?s.push("CALL FUNCTION"):t===o.ENDIF?s.push("END IF"):t===o.ELSE?s.push("ELSE"):t===o.RANDOM?s.push("X = RANDOM"):t===o.INCREMENT?s.push("X = X + 1"):t===o.DECREMENT?s.push("X = X - 1"):s.push(t)}return s.join(`
`)}let E=!1,x=null;function de(e,a,o,s,n,t,i,h){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(x&&(clearInterval(x),x=null),e.isAudioPlaying()||E){e.stopAllSounds(),G(e),t(!1),E=!1;return}if(E=!0,a){const p=e.currentCodes;if(p&&p.length>0){const w=X([...p],h),m=_(w,e.codeLibrary,e.commands);if(m){const d=I(m);n(d);const c=Y(d);if(!c.valid&&c.error){e.readCode(c.error),E=!1;return}d&&d.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(d),t(!0),x=setInterval(()=>{e.isAudioPlaying()||(t(!1),E=!1,x&&(clearInterval(x),x=null))},100)):E=!1;return}}E=!1}const r=s.current?.value||o;if(r&&r.trim()){const p=Y(r);if(!p.valid&&p.error){e.readCode(p.error),E=!1;return}}r&&r.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(r),t(!0),x=setInterval(()=>{e.isAudioPlaying()||(t(!1),E=!1,x&&(clearInterval(x),x=null))},100)):!r&&!a?(n(i),e.runTextCode(i),t(!0),x=setInterval(()=>{e.isAudioPlaying()||(t(!1),E=!1,x&&(clearInterval(x),x=null))},100)):(e.readCode("No code to run."),E=!1)}}let $=!1;function ce(e,a,o,s,n,t,i,h){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(e.synthesis.speaking||$){e.synthesis.cancel(),t(!1),$=!1;return}if(e.isAudioPlaying()){e.stopAllSounds();return}if($=!0,a){const p=e.currentCodes;if(p&&p.length>0){const w=X([...p],h),m=_(w,e.codeLibrary,e.commands);if(m){const d=I(m);n(d),d&&d.trim()?(e.readCode(d),t(!0)):$=!1;return}}$=!1}const r=s.current?.value||o;r&&r.trim()?(e.readCode(r),t(!0)):!r&&!a?(n(i),e.readCode(i),t(!0)):(e.readCode("No code to read."),$=!1)}}function V(e,a,o,s){const n=new window.Howl({src:[`${s}/assets/sound/${a}.mp3`],volume:1,sprite:e.soundSets[a]});e.threads[o]=n}const ue=()=>{if(typeof window<"u"&&window.Howler)try{const e=new window.Howl({src:["data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YQAAAAA="],volume:0,onload:()=>{e.play(),e.unload()}})}catch(e){console.error("Failed to initialize audio context:",e)}if(typeof window<"u"&&window.speechSynthesis)try{const e=new SpeechSynthesisUtterance("");e.volume=0,window.speechSynthesis.speak(e),window.speechSynthesis.cancel()}catch(e){console.error("Failed to initialize speech synthesis:",e)}},M="https://raw.githubusercontent.com/armbennett/tangible-11ty/main",fe=[{value:"Numbers",label:"Numbers"},{value:"MusicLoops1",label:"Music Loops 1"},{value:"Mystery",label:"Mystery"},{value:"Notifications",label:"Notifications"},{value:"OdeToJoy",label:"Ode to Joy"},{value:"FurElise",label:"Fur Elise"}],U=`Thread 1
Loop 4 times
Play 5
End loop
Play 7

Thread 2
Delay 4
Loop 3 times
Play 8
End loop`;function he(){const[e,a]=v.useState(!1),[o,s]=v.useState(""),[n,t]=v.useState(!0),[i,h]=v.useState(["Numbers","Notifications","Notifications"]),[r,p]=v.useState(null),[w,m]=v.useState(!1),[d,c]=v.useState(!1),[A,T]=v.useState(0),[f,u]=v.useState(0),[b,j]=v.useState(!1),D=v.useRef(null),S=v.useRef(0),H=v.useCallback((N,y,g)=>{V(N,y,g,M)},[]);ne(e,f),ie(r,w,m),re(M,p,t,H);const O=de(r,e,o,D,s,c,U,f),P=ce(r,e,o,D,s,m,U,f);le(O,e,r,M,[r,e,o]);const F=N=>{N.stopPropagation();const y=Date.now();if(y-S.current<300)return;if(S.current=y,!r){console.error("Tangible instance not initialized");return}b||(ue(),j(!0));const g=!e;r.cameraStatus=g,window.TopCodes&&(window.TopCodes.startStopVideoScan("video-canvas",r.mode),g||setTimeout(()=>{const z=document.getElementById("video-canvas-video");z&&(z.srcObject=null,z.remove()),delete window.TopCodes._mediaStreams["video-canvas"]},100)),a(g)},W=N=>{N.stopPropagation();const y=Date.now();y-S.current<300||(S.current=y,T(g=>(g+90)%360))},J=N=>{N.stopPropagation();const y=Date.now();y-S.current<300||(S.current=y,u(g=>(g+90)%360))},Q=(N,y)=>{const g=[...i];g[N]=y,h(g),r&&V(r,y,N,M)};return l.jsxs("div",{className:"app-container",children:[l.jsx(q,{cameraEnabled:e,isPlaying:d,isReading:w,isLoading:n,tangibleInstance:r,onCameraToggle:F,onPlayStop:O,onRead:P}),l.jsx(K,{cameraEnabled:e,rotation:A,readingOrderRotation:f,onRotate:W,onReadingOrderRotate:J}),l.jsx(ee,{cameraEnabled:e,codeText:o,textareaRef:D,soundSets:i,soundSetOptions:fe,onCodeTextChange:s,onSoundSetChange:Q,placeholder:U})]})}function ve({}){return[{title:"TIBBL"},{name:"description",content:"TIBBL web application"}]}const me=Z(function(){return l.jsx(he,{})});export{me as default,ve as meta};
