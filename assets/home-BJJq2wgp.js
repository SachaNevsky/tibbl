import{p as i,a as p,w as V}from"./chunk-EPOLDU6W-CP3WDhNt.js";function O({cameraEnabled:e,isPlaying:a,isReading:t,isLoading:n,tangibleInstance:o,onCameraToggle:s,onPlayStop:r,onRead:l}){return i.jsxs("header",{className:"header",role:"banner",children:[i.jsx("div",{className:"logo-container",children:i.jsx("img",{src:"https://armbennett.github.io/tangible-11ty/assets/img/tibbl-logo.png",alt:"Application logo",className:"logo"})}),i.jsxs("nav",{className:"header-buttons",role:"navigation","aria-label":"Main navigation",children:[i.jsxs("button",{className:"header-button",onClick:s,"aria-label":e?"Disable camera":"Enable camera","aria-pressed":e,disabled:n||!o,children:[i.jsx("i",{className:"fa-solid fa-camera fa-2xl","aria-hidden":"true"}),i.jsx("span",{children:"Camera"})]}),i.jsxs("button",{className:"header-button",onClick:r,"aria-label":a?"Stop code execution":"Play and execute code","aria-pressed":a,disabled:n||!o,children:[i.jsx("i",{className:`fa-solid ${a?"fa-stop":"fa-play"} fa-2xl`,"aria-hidden":"true"}),i.jsx("span",{children:a?"Stop":"Play"})]}),i.jsxs("button",{className:"header-button",onClick:l,"aria-label":t?"Stop reading code":"Read out code text","aria-pressed":t,disabled:n||!o,children:[i.jsx("i",{className:"fa-brands fa-readme fa-2xl","aria-hidden":"true"}),i.jsx("span",{children:t?"Stop":"Read"})]})]})]})}function D({cameraEnabled:e,rotation:a,onRotate:t}){const n=a===90||a===270;return i.jsxs(i.Fragment,{children:[e&&i.jsx("section",{className:"camera-section",role:"region","aria-label":"Camera view",children:i.jsxs("div",{className:"video-container",children:[i.jsx("canvas",{id:"video-canvas",width:"640",height:"480","aria-label":"Camera view and code tile detection overlay",className:n?"rotated-sideways":"",style:{transform:`rotate(${a}deg)`}}),i.jsx("button",{className:"rotate-button",onClick:t,"aria-label":`Rotate camera view 90 degrees clockwise (currently ${a} degrees)`,type:"button",children:i.jsx("i",{className:"fa-solid fa-rotate-right","aria-hidden":"true"})})]})}),!e&&i.jsx("canvas",{id:"video-canvas",width:"640",height:"480",style:{display:"none"}})]})}function z({threadNumber:e,value:a,onChange:t,soundSets:n}){const o=`thread${e}`,s=`Thread ${e}`;return i.jsxs("div",{className:"dropdown-group",children:[i.jsx("label",{htmlFor:o,className:"dropdown-label",children:s}),i.jsx("select",{id:o,className:"dropdown",value:a,onChange:r=>t(r.target.value),"aria-label":`Select ${s} sound options`,children:n.map(r=>i.jsx("option",{value:r.value,children:r.label},r.value))})]})}function G({cameraEnabled:e,codeText:a,textareaRef:t,soundSets:n,soundSetOptions:o,onCodeTextChange:s,onSoundSetChange:r}){return i.jsxs("section",{className:`output-section ${e?"camera-active":""}`,role:"region","aria-label":"Code output and thread selection",children:[i.jsx("div",{className:"textbox-container",children:i.jsx("textarea",{ref:t,value:a,onChange:l=>s(l.target.value),className:"output-textbox",placeholder:`Thread 1
Loop 4 times
Play 5
End loop
Play 7

Thread 2
Delay 4
Loop 3 times
Play 8
End loop`,"aria-label":"Code output text area"})}),i.jsxs("div",{className:"dropdown-container",children:[i.jsx(z,{threadNumber:1,value:n[0],onChange:l=>r(0,l),soundSets:o}),i.jsx(z,{threadNumber:2,value:n[1],onChange:l=>r(1,l),soundSets:o}),i.jsx(z,{threadNumber:3,value:n[2],onChange:l=>r(2,l),soundSets:o})]})]})}function X(e,a){return Math.abs(e.y-a.y)<=40?e.x==a.x?0:e.x<a.x?1:-1:e.y<a.y?-1:1}function Y(e){e.sort(X);let a=[],t=Array(),n=-1;for(let o=0;o<e.length;o++)n>=0&&e[o].y-n>=40?(a.push(t),t=Array(),n=e[o].y):n<0&&(n=e[o].y),t.push(e[o]);return a.push(t),a}function _(e){p.useEffect(()=>{if(!e)return;const a=f=>{const S=Y(f.detail.topcodes),g=document.getElementById("video-canvas-video"),h=document.getElementById("video-canvas");if(!g||!h||g.readyState<2)return;const u=h.getContext("2d");if(!u)return;const b=g.videoWidth,w=g.videoHeight,R=w>b;let N,W;R?(N=b,W=w):(N=640,W=480),(h.width!==N||h.height!==W)&&(h.width=N,h.height=W),u.clearRect(0,0,h.width,h.height),u.drawImage(g,0,0,h.width,h.height),u.fillStyle="$00640080",u.strokeStyle="#006400",u.lineWidth=5;let k=1;for(let L=0;L<S.length;L++)for(let H=0;H<S[L].length;H++){const j=S[L][H],A=h.width-j.x,P=j.y;u.beginPath(),u.arc(A,P,j.radius,0,Math.PI*2),u.fill(),u.stroke(),u.fillStyle="rgba(255, 255, 255, 1)",u.font="900 28px monospace",u.textAlign="center",u.textBaseline="middle",u.fillText(`${k}`,A,P),u.fillStyle="#00640080",k++}},t=()=>{const f=document.getElementById("video-canvas-video"),d=document.getElementById("video-canvas"),S=document.querySelector(".video-container");if(f&&d&&S){f.style.display="none";const g=f.videoWidth||640,h=f.videoHeight||480,u=h>g;let b,w;u?(b=g,w=h):(b=640,w=480),(d.width!==b||d.height!==w)&&(d.width=b,d.height=w),S.contains(d)||S.appendChild(d);const R=d.classList.contains("rotated-sideways");d.style.display="block",d.style.position="relative",d.style.objectFit="contain",R?(d.style.width="auto",d.style.height="auto",d.style.maxWidth="50vh",d.style.maxHeight="none"):(d.style.width="100%",d.style.height="auto",d.style.maxHeight="50vh",d.style.maxWidth="")}},n=document.getElementById("video-canvas-video"),o=()=>{n&&t()},s=()=>{t()};n&&(n.readyState>=1&&t(),n.addEventListener("loadedmetadata",o),n.addEventListener("resize",s));const r=()=>{setTimeout(()=>{t()},100)};window.addEventListener("orientationchange",r),window.addEventListener("resize",r);const l=setInterval(()=>{const f=document.getElementById("video-canvas-video");f&&f.readyState>=1&&(t(),clearInterval(l))},100),c=setTimeout(()=>clearInterval(l),5e3);window.addEventListener("topcodes-detected",a);const v=document.getElementById("video-canvas");let m=null;return v&&(m=new MutationObserver(()=>{t()}),m.observe(v,{attributes:!0,attributeFilter:["class"]})),()=>{clearInterval(l),clearTimeout(c),window.removeEventListener("topcodes-detected",a),window.removeEventListener("orientationchange",r),window.removeEventListener("resize",r),n&&(n.removeEventListener("loadedmetadata",o),n.removeEventListener("resize",s)),m&&m.disconnect()}},[e])}function J(e,a,t){p.useEffect(()=>{if(!e)return;const n=setInterval(()=>{a&&!e.synthesis.speaking&&t(!1)},100);return()=>clearInterval(n)},[e,a,t])}async function Q(e,a){const n=await(await fetch(`${e}/assets/js/howler.js`)).text(),o=document.createElement("script");o.textContent=n,document.head.appendChild(o);const r=await(await fetch(`${e}/assets/js/topcodes.js`)).text(),l=document.createElement("script");l.textContent=r,document.head.appendChild(l);let m=(await(await fetch(`${e}/assets/js/tangible.js`)).text()).replace("export default class Tangible","window.Tangible = class Tangible");m=m.replace(/setupTangible\(\) \{[\s\S]*?setVideoFrameCallback\("video-canvas", function \(jsonString\) \{[\s\S]*?\}, this\);[\s\S]*?\}/,`setupTangible() {
        this.setVideoCanvasHeight('video-canvas');
        let tangible = this;
        
        TopCodes.setVideoFrameCallback("video-canvas", function (jsonString) {
            var json = JSON.parse(jsonString);
            var topcodes = json.topcodes;
            tangible.currentCodes = topcodes;
            tangible.once = true;
            
            const event = new CustomEvent('topcodes-detected', { 
                detail: { topcodes: topcodes } 
            });
            window.dispatchEvent(event);
        }, this);
    }`);const f=document.createElement("script");if(f.textContent=m,document.head.appendChild(f),await new Promise(d=>setTimeout(d,200)),window.Tangible){const d=new window.Tangible;return d.setupTangible(),a(d,"Numbers",0),a(d,"Notifications",1),a(d,"Notifications",2),d}else return console.error("window.Tangible not available"),null}function Z(e,a,t,n){p.useEffect(()=>{(async()=>{try{const s=await Q(e,n);a(s),t(!1)}catch(s){console.error("Error loading scripts:",s),t(!1)}})()},[e,a,t,n])}let T=!1,E=[];function q(e,a,t,n){p.useEffect(()=>{const o=s=>{s.touches.length===3&&(s.preventDefault(),T&&(E.forEach(r=>clearTimeout(r)),E=[],t&&t.synthesis.cancel(),T=!1),a&&t?(T=!0,(async()=>{t.readCode("3");const l=setTimeout(async()=>{if(!T)return;t.readCode("2");const c=setTimeout(async()=>{if(!T)return;t.readCode("1");const v=setTimeout(()=>{T&&(T=!1,E=[],e())},1e3);E.push(v)},1e3);E.push(c)},1e3);E.push(l)})()):e())};return document.addEventListener("touchstart",o,{passive:!1}),()=>{document.removeEventListener("touchstart",o),E.forEach(s=>clearTimeout(s)),E=[],T=!1}},n)}function U(e){return e.replace(/<br\/>/g,`
`).replace(/,\s*X:\[object Object\]/g,"").toLowerCase().replace(/(^|\n)([a-z])/g,(a,t,n)=>t+n.toUpperCase()).replace(/x/g,"X")}function F(e){const a=e.split(`
`).map(o=>o.trim().toLowerCase()),t=[];let n=!1;for(let o=0;o<a.length;o++){const s=a[o];if(s.startsWith("loop"))t.push({type:"loop",index:o+1});else if(s.startsWith("end loop")||s.startsWith("endloop")){if(t.length===0||t[t.length-1].type!=="loop")return{valid:!1,error:`Unexpected end loop at position ${o+1}`};t.pop()}else if(s.startsWith("if"))t.push({type:"if",index:o+1});else if(s.startsWith("end if")||s.startsWith("endif")){if(t.length===0||t[t.length-1].type!=="if")return{valid:!1,error:`Unexpected end if at position ${o+1}`};t.pop()}else if(s.startsWith("function"))t.push({type:"function",index:o+1});else if(s.startsWith("end function")||s.startsWith("endfunction")){if(t.length===0||t[t.length-1].type!=="function")return{valid:!1,error:`Unexpected end function at position ${o+1}`};t.pop()}else if(s.startsWith("x =")||s.startsWith("x="))n=!0;else if((s.startsWith("play x")||s.startsWith("if x"))&&!n)return{valid:!1,error:`Variable used at ${o+1} without being set.`}}if(t.length>0){const o=t[t.length-1];return{valid:!1,error:`Missing end tile for ${o.type} in position ${o.index}.`}}return{valid:!0}}let C=!1,y=null;function K(e,a,t,n,o,s){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(y&&(clearInterval(y),y=null),e.isAudioPlaying()||C){e.stopAllSounds(),s(!1),C=!1;return}if(C=!0,a){const l=e.scanCode();if(l){const c=U(l);o(c);const v=F(c);if(!v.valid&&v.error){e.readCode(v.error),C=!1;return}c&&c.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(c),s(!0),y=setInterval(()=>{e.isAudioPlaying()||(s(!1),C=!1,y&&(clearInterval(y),y=null))},100)):C=!1;return}C=!1}const r=n.current?.value||t;if(r&&r.trim()){const l=F(r);if(!l.valid&&l.error){e.readCode(l.error),C=!1;return}}r&&r.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(r),s(!0),y=setInterval(()=>{e.isAudioPlaying()||(s(!1),C=!1,y&&(clearInterval(y),y=null))},100)):(e.readCode("No code to run."),C=!1)}}let $=!1;function I(e,a,t,n,o,s){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(e.synthesis.speaking||$){e.synthesis.cancel(),s(!1),$=!1;return}if(e.isAudioPlaying()){e.stopAllSounds();return}if($=!0,a){const l=e.scanCode();if(l){const c=U(l);o(c),c&&c.trim()?(e.readCode(c),s(!0)):$=!1;return}$=!1}const r=n.current?.value||t;r&&r.trim()?(e.readCode(r),s(!0)):(e.readCode("No code to read."),$=!1)}}function M(e,a,t,n){const o=new window.Howl({src:[`${n}/assets/sound/${a}.mp3`],volume:.2,sprite:e.soundSets[a]});e.threads[t]=o}const B="https://raw.githubusercontent.com/armbennett/tangible-11ty/main",ee=[{value:"Numbers",label:"Numbers"},{value:"MusicLoops1",label:"Music Loops 1"},{value:"Mystery",label:"Mystery"},{value:"Notifications",label:"Notifications"},{value:"OdeToJoy",label:"Ode to Joy"},{value:"FurElise",label:"Fur Elise"}],te=()=>{if(typeof window<"u"&&window.Howler)try{const e=new window.Howl({src:["data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YQAAAAA="],volume:0,onload:()=>{e.play(),e.unload()}})}catch(e){console.error("Failed to initialize audio context:",e)}if(typeof window<"u"&&window.speechSynthesis)try{const e=new SpeechSynthesisUtterance("");e.volume=0,window.speechSynthesis.speak(e),window.speechSynthesis.cancel()}catch(e){console.error("Failed to initialize speech synthesis:",e)}};function oe(){const[e,a]=p.useState(!1),[t,n]=p.useState(""),[o,s]=p.useState(!0),[r,l]=p.useState(["Numbers","Notifications","Notifications"]),[c,v]=p.useState(null),[m,f]=p.useState(!1),[d,S]=p.useState(!1),[g,h]=p.useState(0),[u,b]=p.useState(!1),w=p.useRef(null),R=p.useCallback((x,j,A)=>{M(x,j,A,B)},[]);_(e),J(c,m,f),Z(B,v,s,R);const N=K(c,e,t,w,n,S),W=I(c,e,t,w,n,f);q(N,e,c,[c,e,t]);const k=()=>{if(!c){console.error("Tangible instance not initialized");return}u||(te(),b(!0));const x=!e;c.cameraStatus=x,window.TopCodes&&(window.TopCodes.startStopVideoScan("video-canvas",c.mode),x||setTimeout(()=>{delete window.TopCodes._mediaStreams["video-canvas"]},100)),a(x)},L=()=>{h(x=>(x+90)%360)},H=(x,j)=>{const A=[...r];A[x]=j,l(A),c&&M(c,j,x,B)};return i.jsxs("div",{className:"app-container",children:[i.jsx(O,{cameraEnabled:e,isPlaying:d,isReading:m,isLoading:o,tangibleInstance:c,onCameraToggle:k,onPlayStop:N,onRead:W}),i.jsx(D,{cameraEnabled:e,rotation:g,onRotate:L}),i.jsx(G,{cameraEnabled:e,codeText:t,textareaRef:w,soundSets:r,soundSetOptions:ee,onCodeTextChange:n,onSoundSetChange:H})]})}function ne({}){return[{title:"TIBBL"},{name:"description",content:"TIBBL web application"}]}const se=V(function(){return i.jsx(oe,{})});export{se as default,ne as meta};
