import{p as r,a as g,w as M}from"./chunk-EPOLDU6W-CP3WDhNt.js";function V({cameraEnabled:e,isPlaying:n,isReading:t,isLoading:o,tangibleInstance:s,onCameraToggle:a,onPlayStop:l,onRead:d}){return r.jsxs("header",{className:"header",role:"banner",children:[r.jsx("div",{className:"logo-container",children:r.jsx("img",{src:"https://armbennett.github.io/tangible-11ty/assets/img/tibbl-logo.png",alt:"Application logo",className:"logo"})}),r.jsxs("nav",{className:"header-buttons",role:"navigation","aria-label":"Main navigation",children:[r.jsxs("button",{className:"header-button",onClick:a,"aria-label":e?"Disable camera":"Enable camera","aria-pressed":e,disabled:o||!s,children:[r.jsx("i",{className:"fa-solid fa-camera fa-2xl","aria-hidden":"true"}),r.jsx("span",{children:"Camera"})]}),r.jsxs("button",{className:"header-button",onClick:l,"aria-label":n?"Stop code execution":"Play and execute code","aria-pressed":n,disabled:o||!s,children:[r.jsx("i",{className:`fa-solid ${n?"fa-stop":"fa-play"} fa-2xl`,"aria-hidden":"true"}),r.jsx("span",{children:n?"Stop":"Play"})]}),r.jsxs("button",{className:"header-button",onClick:d,"aria-label":t?"Stop reading code":"Read out code text","aria-pressed":t,disabled:o||!s,children:[r.jsx("i",{className:"fa-brands fa-readme fa-2xl","aria-hidden":"true"}),r.jsx("span",{children:t?"Stop":"Read"})]})]})]})}function O({cameraEnabled:e,rotation:n,onRotate:t}){const o=n===90||n===270;return r.jsxs(r.Fragment,{children:[e&&r.jsx("section",{className:"camera-section",role:"region","aria-label":"Camera view",children:r.jsxs("div",{className:"video-container",children:[r.jsx("canvas",{id:"video-canvas",width:"640",height:"480","aria-label":"Camera view and code tile detection overlay",className:o?"rotated-sideways":"",style:{transform:`rotate(${n}deg)`}}),r.jsx("button",{className:"rotate-button",onClick:t,"aria-label":`Rotate camera view 90 degrees clockwise (currently ${n} degrees)`,type:"button",children:r.jsx("i",{className:"fa-solid fa-rotate-right","aria-hidden":"true"})})]})}),!e&&r.jsx("canvas",{id:"video-canvas",width:"640",height:"480",style:{display:"none"}})]})}function k({threadNumber:e,value:n,onChange:t,soundSets:o}){const s=`thread${e}`,a=`Thread ${e}`;return r.jsxs("div",{className:"dropdown-group",children:[r.jsx("label",{htmlFor:s,className:"dropdown-label",children:a}),r.jsx("select",{id:s,className:"dropdown",value:n,onChange:l=>t(l.target.value),"aria-label":`Select ${a} sound options`,children:o.map(l=>r.jsx("option",{value:l.value,children:l.label},l.value))})]})}function U({cameraEnabled:e,codeText:n,textareaRef:t,soundSets:o,soundSetOptions:s,onCodeTextChange:a,onSoundSetChange:l}){return r.jsxs("section",{className:`output-section ${e?"camera-active":""}`,role:"region","aria-label":"Code output and thread selection",children:[r.jsx("div",{className:"textbox-container",children:r.jsx("textarea",{ref:t,value:n,onChange:d=>a(d.target.value),className:"output-textbox",placeholder:`Thread 1
Loop 4 times
Play 5
End loop
Play 7

Thread 2
Delay 4
Loop 3 times
Play 8
End loop`,"aria-label":"Code output text area"})}),r.jsxs("div",{className:"dropdown-container",children:[r.jsx(k,{threadNumber:1,value:o[0],onChange:d=>l(0,d),soundSets:s}),r.jsx(k,{threadNumber:2,value:o[1],onChange:d=>l(1,d),soundSets:s}),r.jsx(k,{threadNumber:3,value:o[2],onChange:d=>l(2,d),soundSets:s})]})]})}function D(e){g.useEffect(()=>{if(!e)return;const n=p=>{const b=p.detail.topcodes,y=document.getElementById("video-canvas-video"),u=document.getElementById("video-canvas");if(!y||!u||y.readyState<2)return;const i=u.getContext("2d");if(!i)return;const v=y.videoWidth,f=y.videoHeight,R=f>v,H=f>v;let N,L;H?(N=v,L=f):(N=640,L=480),(u.width!==N||u.height!==L)&&(u.width=N,u.height=L,console.log(`Canvas auto-resized during frame update: ${N}x${L}`)),i.clearRect(0,0,u.width,u.height),i.drawImage(y,0,0,u.width,u.height),i.fillStyle="rgba(255, 0, 0, 0.3)",i.strokeStyle="rgba(255, 0, 0, 0.8)",i.lineWidth=2;for(let m=0;m<b.length;m++){const T=b[m],j=u.width-T.x,P=T.y;i.beginPath(),i.arc(j,P,T.radius,0,Math.PI*2),i.fill(),i.stroke(),i.fillStyle="rgba(255, 255, 255, 1)",i.font="14px monospace",i.textAlign="center",i.textBaseline="middle",i.fillText(`(${Math.round(j)}, ${Math.round(P)})`,j,P),i.fillStyle="rgba(255, 0, 0, 0.3)"}i.fillStyle="rgba(255, 0, 0, 0.7)",i.fillRect(0,0,100,44),i.fillStyle="rgba(255, 255, 255, 1)",i.font="bold 14px monospace",i.textAlign="left",i.textBaseline="middle",i.fillText(R?"Portrait":"Landscape",5,10),i.fillText(`(${u.width} x ${u.height})`,5,30),i.fillStyle="rgba(0, 100, 0, 0.8)",i.fillRect(0,u.height-110,180,110),i.fillStyle="rgba(255, 255, 255, 1)",i.font="12px monospace",i.textAlign="left",i.textBaseline="top",i.fillText(`Video: ${v}x${f}`,5,u.height-105),i.fillText(`Canvas: ${u.width}x${u.height}`,5,u.height-90),i.fillText(`Aspect: ${(v/f).toFixed(2)}`,5,u.height-75),i.fillText(`TopCodes: ${b.length}`,5,u.height-60),i.fillText(`Browser: ${navigator.userAgent.includes("Safari")?"Safari":navigator.userAgent.includes("Chrome")?"Chrome":navigator.userAgent.includes("Firefox")?"Firefox":"Other"}`,5,u.height-45),i.fillText(`Platform: ${navigator.platform}`,5,u.height-30),i.fillText(`Ready: ${y.readyState}/4`,5,u.height-15)},t=()=>{const p=document.getElementById("video-canvas-video"),c=document.getElementById("video-canvas"),b=document.querySelector(".video-container");if(p&&c&&b){p.style.display="none";const y=p.videoWidth||640,u=p.videoHeight||480,i=u>y;let v,f;i?(v=y,f=u,console.log(`Portrait mode detected: Using video dimensions ${v}x${f}`)):(v=640,f=480,console.log(`Landscape mode detected: Using fixed dimensions ${v}x${f}`)),(c.width!==v||c.height!==f)&&(c.width=v,c.height=f,console.log(`Canvas resized to ${v}x${f}`)),b.contains(c)||b.appendChild(c);const R=c.classList.contains("rotated-sideways");c.style.display="block",c.style.position="relative",c.style.objectFit="contain",R?(c.style.width="auto",c.style.height="auto",c.style.maxWidth="50vh",c.style.maxHeight="none"):(c.style.width="100%",c.style.height="auto",c.style.maxHeight="50vh",c.style.maxWidth="")}},o=document.getElementById("video-canvas-video"),s=()=>{o&&(console.log(`Video metadata loaded: ${o.videoWidth}x${o.videoHeight}`),t())},a=()=>{console.log("Video resize event triggered"),t()};o&&(o.readyState>=1&&t(),o.addEventListener("loadedmetadata",s),o.addEventListener("resize",a));const l=()=>{console.log("Orientation change detected"),setTimeout(()=>{t()},100)};window.addEventListener("orientationchange",l),window.addEventListener("resize",l);const d=setInterval(()=>{const p=document.getElementById("video-canvas-video");p&&p.readyState>=1&&(t(),clearInterval(d))},100),h=setTimeout(()=>clearInterval(d),5e3);window.addEventListener("topcodes-detected",n);const x=document.getElementById("video-canvas");let w=null;return x&&(w=new MutationObserver(()=>{t()}),w.observe(x,{attributes:!0,attributeFilter:["class"]})),()=>{clearInterval(d),clearTimeout(h),window.removeEventListener("topcodes-detected",n),window.removeEventListener("orientationchange",l),window.removeEventListener("resize",l),o&&(o.removeEventListener("loadedmetadata",s),o.removeEventListener("resize",a)),w&&w.disconnect()}},[e])}function _(e,n,t){g.useEffect(()=>{if(!e)return;const o=setInterval(()=>{n&&!e.synthesis.speaking&&t(!1)},100);return()=>clearInterval(o)},[e,n,t])}async function J(e,n){const o=await(await fetch(`${e}/assets/js/howler.js`)).text(),s=document.createElement("script");s.textContent=o,document.head.appendChild(s);const l=await(await fetch(`${e}/assets/js/topcodes.js`)).text(),d=document.createElement("script");d.textContent=l,document.head.appendChild(d);let w=(await(await fetch(`${e}/assets/js/tangible.js`)).text()).replace("export default class Tangible","window.Tangible = class Tangible");w=w.replace(/setupTangible\(\) \{[\s\S]*?setVideoFrameCallback\("video-canvas", function \(jsonString\) \{[\s\S]*?\}, this\);[\s\S]*?\}/,`setupTangible() {
        this.setVideoCanvasHeight('video-canvas');
        let tangible = this;
        
        TopCodes.setVideoFrameCallback("video-canvas", function (jsonString) {
            var json = JSON.parse(jsonString);
            var topcodes = json.topcodes;
            tangible.currentCodes = topcodes;
            tangible.once = true;
            
            const event = new CustomEvent('topcodes-detected', { 
                detail: { topcodes: topcodes } 
            });
            window.dispatchEvent(event);
        }, this);
    }`);const p=document.createElement("script");if(p.textContent=w,document.head.appendChild(p),await new Promise(c=>setTimeout(c,200)),window.Tangible){const c=new window.Tangible;return c.setupTangible(),n(c,"Numbers",0),n(c,"Notifications",1),n(c,"Notifications",2),c}else return console.error("window.Tangible not available"),null}function X(e,n,t,o){g.useEffect(()=>{(async()=>{try{const a=await J(e,o);n(a),t(!1)}catch(a){console.error("Error loading scripts:",a),t(!1)}})()},[e,n,t,o])}let E=!1,$=[];function G(e,n,t,o){g.useEffect(()=>{const s=a=>{a.touches.length===3&&(a.preventDefault(),E&&($.forEach(l=>clearTimeout(l)),$=[],t&&t.synthesis.cancel(),E=!1),n&&t?(E=!0,(async()=>{t.readCode("3");const d=setTimeout(async()=>{if(!E)return;t.readCode("2");const h=setTimeout(async()=>{if(!E)return;t.readCode("1");const x=setTimeout(()=>{E&&(E=!1,$=[],e())},1e3);$.push(x)},1e3);$.push(h)},1e3);$.push(d)})()):e())};return document.addEventListener("touchstart",s,{passive:!1}),()=>{document.removeEventListener("touchstart",s),$.forEach(a=>clearTimeout(a)),$=[],E=!1}},o)}function F(e){return e.replace(/<br\/>/g,`
`).replace(/,\s*X:\[object Object\]/g,"").toLowerCase().replace(/(^|\n)([a-z])/g,(n,t,o)=>t+o.toUpperCase()).replace(/x/g,"X")}function A(e){const n=e.split(`
`).map(s=>s.trim().toLowerCase()),t=[];let o=!1;for(let s=0;s<n.length;s++){const a=n[s];if(a.startsWith("loop"))t.push({type:"loop",index:s+1});else if(a.startsWith("end loop")||a.startsWith("endloop")){if(t.length===0||t[t.length-1].type!=="loop")return{valid:!1,error:`Unexpected end loop at position ${s+1}`};t.pop()}else if(a.startsWith("if"))t.push({type:"if",index:s+1});else if(a.startsWith("end if")||a.startsWith("endif")){if(t.length===0||t[t.length-1].type!=="if")return{valid:!1,error:`Unexpected end if at position ${s+1}`};t.pop()}else if(a.startsWith("function"))t.push({type:"function",index:s+1});else if(a.startsWith("end function")||a.startsWith("endfunction")){if(t.length===0||t[t.length-1].type!=="function")return{valid:!1,error:`Unexpected end function at position ${s+1}`};t.pop()}else if(a.startsWith("x =")||a.startsWith("x="))o=!0;else if((a.startsWith("play x")||a.startsWith("if x"))&&!o)return{valid:!1,error:`Variable used at ${s+1} without being set.`}}if(t.length>0){const s=t[t.length-1];return{valid:!1,error:`Missing end tile for ${s.type} in position ${s.index}.`}}return{valid:!0}}let S=!1,C=null;function q(e,n,t,o,s,a){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(C&&(clearInterval(C),C=null),e.isAudioPlaying()||S){e.stopAllSounds(),a(!1),S=!1;return}if(S=!0,n){const d=e.scanCode();if(d){const h=F(d);s(h);const x=A(h);if(!x.valid&&x.error){e.readCode(x.error),S=!1;return}h&&h.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(h),a(!0),C=setInterval(()=>{e.isAudioPlaying()||(a(!1),S=!1,C&&(clearInterval(C),C=null))},100)):S=!1;return}S=!1}const l=o.current?.value||t;if(l&&l.trim()){const d=A(l);if(!d.valid&&d.error){e.readCode(d.error),S=!1;return}}l&&l.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(l),a(!0),C=setInterval(()=>{e.isAudioPlaying()||(a(!1),S=!1,C&&(clearInterval(C),C=null))},100)):(e.readCode("No code to run."),S=!1)}}let W=!1;function Y(e,n,t,o,s,a){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(e.synthesis.speaking||W){e.synthesis.cancel(),a(!1),W=!1;return}if(e.isAudioPlaying()){e.stopAllSounds();return}if(W=!0,n){const d=e.scanCode();if(d){const h=F(d);s(h),h&&h.trim()?(e.readCode(h),a(!0)):W=!1;return}W=!1}const l=o.current?.value||t;l&&l.trim()?(e.readCode(l),a(!0)):(e.readCode("No code to read."),W=!1)}}function B(e,n,t,o){const s=new window.Howl({src:[`${o}/assets/sound/${n}.mp3`],volume:.2,sprite:e.soundSets[n]});e.threads[t]=s}const z="https://raw.githubusercontent.com/armbennett/tangible-11ty/main",K=[{value:"Numbers",label:"Numbers"},{value:"MusicLoops1",label:"Music Loops 1"},{value:"Mystery",label:"Mystery"},{value:"Notifications",label:"Notifications"},{value:"OdeToJoy",label:"Ode to Joy"},{value:"FurElise",label:"Fur Elise"}];function Q(){const[e,n]=g.useState(!1),[t,o]=g.useState(""),[s,a]=g.useState(!0),[l,d]=g.useState(["Numbers","Notifications","Notifications"]),[h,x]=g.useState(null),[w,p]=g.useState(!1),[c,b]=g.useState(!1),[y,u]=g.useState(0),i=g.useRef(null),v=g.useCallback((m,T,j)=>{B(m,T,j,z)},[]);D(e),_(h,w,p),X(z,x,a,v);const f=q(h,e,t,i,o,b),R=Y(h,e,t,i,o,p);G(f,e,h,[h,e,t]);const H=()=>{if(!h){console.error("Tangible instance not initialized");return}const m=!e;h.cameraStatus=m,window.TopCodes&&(window.TopCodes.startStopVideoScan("video-canvas",h.mode),m||setTimeout(()=>{delete window.TopCodes._mediaStreams["video-canvas"]},100)),n(m)},N=()=>{u(m=>(m+90)%360)},L=(m,T)=>{const j=[...l];j[m]=T,d(j),h&&B(h,T,m,z)};return r.jsxs("div",{className:"app-container",children:[r.jsx(V,{cameraEnabled:e,isPlaying:c,isReading:w,isLoading:s,tangibleInstance:h,onCameraToggle:H,onPlayStop:f,onRead:R}),r.jsx(O,{cameraEnabled:e,rotation:y,onRotate:N}),r.jsx(U,{cameraEnabled:e,codeText:t,textareaRef:i,soundSets:l,soundSetOptions:K,onCodeTextChange:o,onSoundSetChange:L})]})}function I({}){return[{title:"TIBBL"},{name:"description",content:"TIBBL web application"}]}const ee=M(function(){return r.jsx(Q,{})});export{ee as default,I as meta};
