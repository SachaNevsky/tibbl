import{p as i,a as p,w as U}from"./chunk-EPOLDU6W-CP3WDhNt.js";function V({cameraEnabled:e,isPlaying:n,isReading:t,isLoading:a,tangibleInstance:s,onCameraToggle:o,onPlayStop:r,onRead:d}){return i.jsxs("header",{className:"header",role:"banner",children:[i.jsx("div",{className:"logo-container",children:i.jsx("img",{src:"https://armbennett.github.io/tangible-11ty/assets/img/tibbl-logo.png",alt:"Application logo",className:"logo"})}),i.jsxs("nav",{className:"header-buttons",role:"navigation","aria-label":"Main navigation",children:[i.jsxs("button",{className:"header-button",onClick:o,"aria-label":e?"Disable camera":"Enable camera","aria-pressed":e,disabled:a||!s,children:[i.jsx("i",{className:"fa-solid fa-camera fa-2xl","aria-hidden":"true"}),i.jsx("span",{children:"Camera"})]}),i.jsxs("button",{className:"header-button",onClick:r,"aria-label":n?"Stop code execution":"Play and execute code","aria-pressed":n,disabled:a||!s,children:[i.jsx("i",{className:`fa-solid ${n?"fa-stop":"fa-play"} fa-2xl`,"aria-hidden":"true"}),i.jsx("span",{children:n?"Stop":"Play"})]}),i.jsxs("button",{className:"header-button",onClick:d,"aria-label":t?"Stop reading code":"Read out code text","aria-pressed":t,disabled:a||!s,children:[i.jsx("i",{className:"fa-brands fa-readme fa-2xl","aria-hidden":"true"}),i.jsx("span",{children:t?"Stop":"Read"})]})]})]})}function O({cameraEnabled:e,rotation:n,onRotate:t}){const a=n===90||n===270;return i.jsxs(i.Fragment,{children:[e&&i.jsx("section",{className:"camera-section",role:"region","aria-label":"Camera view",children:i.jsxs("div",{className:"video-container",children:[i.jsx("canvas",{id:"video-canvas",width:"640",height:"480","aria-label":"Camera view and code tile detection overlay",className:a?"rotated-sideways":"",style:{transform:`rotate(${n}deg)`}}),i.jsx("button",{className:"rotate-button",onClick:t,"aria-label":`Rotate camera view 90 degrees clockwise (currently ${n} degrees)`,type:"button",children:i.jsx("i",{className:"fa-solid fa-rotate-right","aria-hidden":"true"})})]})}),!e&&i.jsx("canvas",{id:"video-canvas",width:"640",height:"480",style:{display:"none"}})]})}function z({threadNumber:e,value:n,onChange:t,soundSets:a}){const s=`thread${e}`,o=`Thread ${e}`;return i.jsxs("div",{className:"dropdown-group",children:[i.jsx("label",{htmlFor:s,className:"dropdown-label",children:o}),i.jsx("select",{id:s,className:"dropdown",value:n,onChange:r=>t(r.target.value),"aria-label":`Select ${o} sound options`,children:a.map(r=>i.jsx("option",{value:r.value,children:r.label},r.value))})]})}function D({cameraEnabled:e,codeText:n,textareaRef:t,soundSets:a,soundSetOptions:s,onCodeTextChange:o,onSoundSetChange:r}){return i.jsxs("section",{className:`output-section ${e?"camera-active":""}`,role:"region","aria-label":"Code output and thread selection",children:[i.jsx("div",{className:"textbox-container",children:i.jsx("textarea",{ref:t,value:n,onChange:d=>o(d.target.value),className:"output-textbox",placeholder:`Thread 1
Loop 4 times
Play 5
End loop
Play 7

Thread 2
Delay 4
Loop 3 times
Play 8
End loop`,"aria-label":"Code output text area"})}),i.jsxs("div",{className:"dropdown-container",children:[i.jsx(z,{threadNumber:1,value:a[0],onChange:d=>r(0,d),soundSets:s}),i.jsx(z,{threadNumber:2,value:a[1],onChange:d=>r(1,d),soundSets:s}),i.jsx(z,{threadNumber:3,value:a[2],onChange:d=>r(2,d),soundSets:s})]})]})}function G(e){p.useEffect(()=>{if(!e)return;const n=h=>{const b=h.detail.topcodes,g=document.getElementById("video-canvas-video"),u=document.getElementById("video-canvas");if(!g||!u||g.readyState<2)return;const f=u.getContext("2d");if(!f)return;const S=g.videoWidth,x=g.videoHeight,W=x>S;let T,N;W?(T=S,N=x):(T=640,N=480),(u.width!==T||u.height!==N)&&(u.width=T,u.height=N),f.clearRect(0,0,u.width,u.height),f.drawImage(g,0,0,u.width,u.height),f.fillStyle="rgba(255, 0, 0, 0.3)",f.strokeStyle="rgba(255, 0, 0, 0.8)",f.lineWidth=2;for(let L=0;L<b.length;L++){const R=b[L],k=u.width-R.x,v=R.y;f.beginPath(),f.arc(k,v,R.radius,0,Math.PI*2),f.fill(),f.stroke(),f.fillStyle="rgba(255, 0, 0, 0.3)"}},t=()=>{const h=document.getElementById("video-canvas-video"),l=document.getElementById("video-canvas"),b=document.querySelector(".video-container");if(h&&l&&b){h.style.display="none";const g=h.videoWidth||640,u=h.videoHeight||480,f=u>g;let S,x;f?(S=g,x=u):(S=640,x=480),(l.width!==S||l.height!==x)&&(l.width=S,l.height=x),b.contains(l)||b.appendChild(l);const W=l.classList.contains("rotated-sideways");l.style.display="block",l.style.position="relative",l.style.objectFit="contain",W?(l.style.width="auto",l.style.height="auto",l.style.maxWidth="50vh",l.style.maxHeight="none"):(l.style.width="100%",l.style.height="auto",l.style.maxHeight="50vh",l.style.maxWidth="")}},a=document.getElementById("video-canvas-video"),s=()=>{a&&t()},o=()=>{t()};a&&(a.readyState>=1&&t(),a.addEventListener("loadedmetadata",s),a.addEventListener("resize",o));const r=()=>{setTimeout(()=>{t()},100)};window.addEventListener("orientationchange",r),window.addEventListener("resize",r);const d=setInterval(()=>{const h=document.getElementById("video-canvas-video");h&&h.readyState>=1&&(t(),clearInterval(d))},100),c=setTimeout(()=>clearInterval(d),5e3);window.addEventListener("topcodes-detected",n);const m=document.getElementById("video-canvas");let w=null;return m&&(w=new MutationObserver(()=>{t()}),w.observe(m,{attributes:!0,attributeFilter:["class"]})),()=>{clearInterval(d),clearTimeout(c),window.removeEventListener("topcodes-detected",n),window.removeEventListener("orientationchange",r),window.removeEventListener("resize",r),a&&(a.removeEventListener("loadedmetadata",s),a.removeEventListener("resize",o)),w&&w.disconnect()}},[e])}function X(e,n,t){p.useEffect(()=>{if(!e)return;const a=setInterval(()=>{n&&!e.synthesis.speaking&&t(!1)},100);return()=>clearInterval(a)},[e,n,t])}async function _(e,n){const a=await(await fetch(`${e}/assets/js/howler.js`)).text(),s=document.createElement("script");s.textContent=a,document.head.appendChild(s);const r=await(await fetch(`${e}/assets/js/topcodes.js`)).text(),d=document.createElement("script");d.textContent=r,document.head.appendChild(d);let w=(await(await fetch(`${e}/assets/js/tangible.js`)).text()).replace("export default class Tangible","window.Tangible = class Tangible");w=w.replace(/setupTangible\(\) \{[\s\S]*?setVideoFrameCallback\("video-canvas", function \(jsonString\) \{[\s\S]*?\}, this\);[\s\S]*?\}/,`setupTangible() {
        this.setVideoCanvasHeight('video-canvas');
        let tangible = this;
        
        TopCodes.setVideoFrameCallback("video-canvas", function (jsonString) {
            var json = JSON.parse(jsonString);
            var topcodes = json.topcodes;
            tangible.currentCodes = topcodes;
            tangible.once = true;
            
            const event = new CustomEvent('topcodes-detected', { 
                detail: { topcodes: topcodes } 
            });
            window.dispatchEvent(event);
        }, this);
    }`);const h=document.createElement("script");if(h.textContent=w,document.head.appendChild(h),await new Promise(l=>setTimeout(l,200)),window.Tangible){const l=new window.Tangible;return l.setupTangible(),n(l,"Numbers",0),n(l,"Notifications",1),n(l,"Notifications",2),l}else return console.error("window.Tangible not available"),null}function J(e,n,t,a){p.useEffect(()=>{(async()=>{try{const o=await _(e,a);n(o),t(!1)}catch(o){console.error("Error loading scripts:",o),t(!1)}})()},[e,n,t,a])}let j=!1,E=[];function Q(e,n,t,a){p.useEffect(()=>{const s=o=>{o.touches.length===3&&(o.preventDefault(),j&&(E.forEach(r=>clearTimeout(r)),E=[],t&&t.synthesis.cancel(),j=!1),n&&t?(j=!0,(async()=>{t.readCode("3");const d=setTimeout(async()=>{if(!j)return;t.readCode("2");const c=setTimeout(async()=>{if(!j)return;t.readCode("1");const m=setTimeout(()=>{j&&(j=!1,E=[],e())},1e3);E.push(m)},1e3);E.push(c)},1e3);E.push(d)})()):e())};return document.addEventListener("touchstart",s,{passive:!1}),()=>{document.removeEventListener("touchstart",s),E.forEach(o=>clearTimeout(o)),E=[],j=!1}},a)}function M(e){return e.replace(/<br\/>/g,`
`).replace(/,\s*X:\[object Object\]/g,"").toLowerCase().replace(/(^|\n)([a-z])/g,(n,t,a)=>t+a.toUpperCase()).replace(/x/g,"X")}function P(e){const n=e.split(`
`).map(s=>s.trim().toLowerCase()),t=[];let a=!1;for(let s=0;s<n.length;s++){const o=n[s];if(o.startsWith("loop"))t.push({type:"loop",index:s+1});else if(o.startsWith("end loop")||o.startsWith("endloop")){if(t.length===0||t[t.length-1].type!=="loop")return{valid:!1,error:`Unexpected end loop at position ${s+1}`};t.pop()}else if(o.startsWith("if"))t.push({type:"if",index:s+1});else if(o.startsWith("end if")||o.startsWith("endif")){if(t.length===0||t[t.length-1].type!=="if")return{valid:!1,error:`Unexpected end if at position ${s+1}`};t.pop()}else if(o.startsWith("function"))t.push({type:"function",index:s+1});else if(o.startsWith("end function")||o.startsWith("endfunction")){if(t.length===0||t[t.length-1].type!=="function")return{valid:!1,error:`Unexpected end function at position ${s+1}`};t.pop()}else if(o.startsWith("x =")||o.startsWith("x="))a=!0;else if((o.startsWith("play x")||o.startsWith("if x"))&&!a)return{valid:!1,error:`Variable used at ${s+1} without being set.`}}if(t.length>0){const s=t[t.length-1];return{valid:!1,error:`Missing end tile for ${s.type} in position ${s.index}.`}}return{valid:!0}}let C=!1,y=null;function Y(e,n,t,a,s,o){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(y&&(clearInterval(y),y=null),e.isAudioPlaying()||C){e.stopAllSounds(),o(!1),C=!1;return}if(C=!0,n){const d=e.scanCode();if(d){const c=M(d);s(c);const m=P(c);if(!m.valid&&m.error){e.readCode(m.error),C=!1;return}c&&c.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(c),o(!0),y=setInterval(()=>{e.isAudioPlaying()||(o(!1),C=!1,y&&(clearInterval(y),y=null))},100)):C=!1;return}C=!1}const r=a.current?.value||t;if(r&&r.trim()){const d=P(r);if(!d.valid&&d.error){e.readCode(d.error),C=!1;return}}r&&r.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(r),o(!0),y=setInterval(()=>{e.isAudioPlaying()||(o(!1),C=!1,y&&(clearInterval(y),y=null))},100)):(e.readCode("No code to run."),C=!1)}}let A=!1;function Z(e,n,t,a,s,o){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(e.synthesis.speaking||A){e.synthesis.cancel(),o(!1),A=!1;return}if(e.isAudioPlaying()){e.stopAllSounds();return}if(A=!0,n){const d=e.scanCode();if(d){const c=M(d);s(c),c&&c.trim()?(e.readCode(c),o(!0)):A=!1;return}A=!1}const r=a.current?.value||t;r&&r.trim()?(e.readCode(r),o(!0)):(e.readCode("No code to read."),A=!1)}}function F(e,n,t,a){const s=new window.Howl({src:[`${a}/assets/sound/${n}.mp3`],volume:.2,sprite:e.soundSets[n]});e.threads[t]=s}const B="https://raw.githubusercontent.com/armbennett/tangible-11ty/main",q=[{value:"Numbers",label:"Numbers"},{value:"MusicLoops1",label:"Music Loops 1"},{value:"Mystery",label:"Mystery"},{value:"Notifications",label:"Notifications"},{value:"OdeToJoy",label:"Ode to Joy"},{value:"FurElise",label:"Fur Elise"}],K=()=>{if(typeof window<"u"&&window.Howler)try{const e=new window.Howl({src:["data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YQAAAAA="],volume:0,onload:()=>{e.play(),e.unload()}})}catch(e){console.error("Failed to initialize audio context:",e)}if(typeof window<"u"&&window.speechSynthesis)try{const e=new SpeechSynthesisUtterance("");e.volume=0,window.speechSynthesis.speak(e),window.speechSynthesis.cancel()}catch(e){console.error("Failed to initialize speech synthesis:",e)}};function I(){const[e,n]=p.useState(!1),[t,a]=p.useState(""),[s,o]=p.useState(!0),[r,d]=p.useState(["Numbers","Notifications","Notifications"]),[c,m]=p.useState(null),[w,h]=p.useState(!1),[l,b]=p.useState(!1),[g,u]=p.useState(0),[f,S]=p.useState(!1),x=p.useRef(null),W=p.useCallback((v,$,H)=>{F(v,$,H,B)},[]);G(e),X(c,w,h),J(B,m,o,W);const T=Y(c,e,t,x,a,b),N=Z(c,e,t,x,a,h);Q(T,e,c,[c,e,t]);const L=()=>{if(!c){console.error("Tangible instance not initialized");return}f||(K(),S(!0));const v=!e;c.cameraStatus=v,window.TopCodes&&(window.TopCodes.startStopVideoScan("video-canvas",c.mode),v||setTimeout(()=>{delete window.TopCodes._mediaStreams["video-canvas"]},100)),n(v)},R=()=>{u(v=>(v+90)%360)},k=(v,$)=>{const H=[...r];H[v]=$,d(H),c&&F(c,$,v,B)};return i.jsxs("div",{className:"app-container",children:[i.jsx(V,{cameraEnabled:e,isPlaying:l,isReading:w,isLoading:s,tangibleInstance:c,onCameraToggle:L,onPlayStop:T,onRead:N}),i.jsx(O,{cameraEnabled:e,rotation:g,onRotate:R}),i.jsx(D,{cameraEnabled:e,codeText:t,textareaRef:x,soundSets:r,soundSetOptions:q,onCodeTextChange:a,onSoundSetChange:k})]})}function te({}){return[{title:"TIBBL"},{name:"description",content:"TIBBL web application"}]}const oe=U(function(){return i.jsx(I,{})});export{oe as default,te as meta};
