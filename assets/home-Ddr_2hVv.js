import{p as d,a as p,w as de}from"./chunk-EPOLDU6W-CP3WDhNt.js";function ce({cameraEnabled:e,isPlaying:i,isReading:o,isLoading:s,tangibleInstance:n,onCameraToggle:t,onPlayStop:a,onRead:h}){return d.jsxs("header",{className:"header",role:"banner",children:[d.jsx("div",{className:"logo-container","aria-hidden":"true",children:d.jsx("img",{src:"https://armbennett.github.io/tangible-11ty/assets/img/tibbl-logo.png",alt:"Application logo",className:"logo"})}),d.jsxs("nav",{className:"header-buttons",role:"navigation","aria-label":"Main navigation",children:[d.jsxs("button",{className:"header-button",onClick:t,"aria-label":e?"Disable camera":"Enable camera","aria-pressed":e,disabled:s||!n,children:[d.jsx("i",{className:"fa-solid fa-camera fa-2xl","aria-hidden":"true"}),d.jsx("span",{children:"Camera"})]}),d.jsxs("button",{className:"header-button",onClick:a,"aria-label":i?"Stop code execution":"Play and execute code","aria-pressed":i,disabled:s||!n,children:[d.jsx("i",{className:`fa-solid ${i?"fa-stop":"fa-play"} fa-2xl`,"aria-hidden":"true"}),d.jsx("span",{children:i?"Stop":"Play"})]}),d.jsxs("button",{className:"header-button",onClick:h,"aria-label":o?"Stop reading code":"Read out code text","aria-pressed":o,disabled:s||!n,children:[d.jsx("i",{className:"fa-brands fa-readme fa-2xl","aria-hidden":"true"}),d.jsx("span",{children:o?"Stop":"Read"})]})]})]})}function ue({cameraEnabled:e,rotation:i,readingOrderRotation:o,onRotate:s,onReadingOrderRotate:n}){const t=i===90||i===270;return d.jsxs(d.Fragment,{children:[e&&d.jsx("section",{className:"camera-section",role:"region","aria-label":"Camera view",children:d.jsxs("div",{className:"video-container",children:[d.jsx("canvas",{id:"video-canvas",width:"640",height:"480","aria-label":"Camera view and code tile detection overlay",className:t?"rotated-sideways":"",style:{transform:`rotate(${i}deg)`}}),d.jsx("button",{className:"rotate-button",onClick:s,"aria-label":`Rotate camera view 90 degrees clockwise (currently ${i} degrees)`,type:"button",children:d.jsx("i",{className:"fa-solid fa-camera-rotate","aria-hidden":"true"})}),d.jsx("button",{className:"reading-order-button",onClick:n,"aria-label":`Rotate reading order 90 degrees clockwise (currently ${o} degrees)`,type:"button",children:d.jsx("i",{className:"fa-solid fa-rotate-right","aria-hidden":"true"})})]})}),!e&&d.jsx("canvas",{id:"video-canvas",width:"640",height:"480",style:{display:"none"}})]})}function J({threadNumber:e,value:i,onChange:o,soundSets:s}){const n=`thread${e}`,t=`Thread ${e}`;return d.jsxs("div",{className:"dropdown-group",children:[d.jsx("label",{htmlFor:n,className:"dropdown-label",children:t}),d.jsx("select",{id:n,className:"dropdown",value:i,onChange:a=>o(a.target.value),"aria-label":`Select ${t} sound options`,children:s.map(a=>d.jsx("option",{value:a.value,children:a.label},a.value))})]})}function fe({cameraEnabled:e,codeText:i,textareaRef:o,soundSets:s,soundSetOptions:n,onCodeTextChange:t,onSoundSetChange:a,placeholder:h}){return d.jsxs("section",{className:`output-section ${e?"camera-active":""}`,role:"region","aria-label":"Code output and thread selection",children:[d.jsx("div",{className:"textbox-container",children:d.jsx("textarea",{ref:o,value:i,onChange:r=>t(r.target.value),className:"output-textbox",placeholder:h,"aria-label":"Code output text area"})}),d.jsxs("div",{className:"dropdown-container",children:[d.jsx(J,{threadNumber:1,value:s[0],onChange:r=>a(0,r),soundSets:n}),d.jsx(J,{threadNumber:2,value:s[1],onChange:r=>a(1,r),soundSets:n}),d.jsx(J,{threadNumber:3,value:s[2],onChange:r=>a(2,r),soundSets:n})]})]})}function he(e,i){return Math.abs(e.y-i.y)<=40?e.x==i.x?0:e.x<i.x?1:-1:e.y<i.y?-1:1}function pe(e){e.sort(he);let i=[],o=Array(),s=-1;for(let n=0;n<e.length;n++)s>=0&&e[n].y-s>=40?(i.push(o),o=Array(),s=e[n].y):s<0&&(s=e[n].y),o.push(e[n]);return i.push(o),i}function ve(e,i){const o=[];switch(i){case 0:for(let t=0;t<e.length;t++)for(let a=0;a<e[t].length;a++)o.push(e[t][a]);break;case 90:const s=Math.max(...e.map(t=>t.length));for(let t=s-1;t>=0;t--)for(let a=0;a<e.length;a++)t<e[a].length&&o.push(e[a][t]);break;case 180:for(let t=e.length-1;t>=0;t--)for(let a=e[t].length-1;a>=0;a--)o.push(e[t][a]);break;case 270:const n=Math.max(...e.map(t=>t.length));for(let t=0;t<n;t++)for(let a=e.length-1;a>=0;a--)t<e[a].length&&o.push(e[a][t]);break;default:for(let t=0;t<e.length;t++)for(let a=0;a<e[t].length;a++)o.push(e[t][a])}return o}function me(e,i){if(i===0)return e;const o=i*Math.PI/180;let s=e.angle-o;for(;s<0;)s+=2*Math.PI;for(;s>=2*Math.PI;)s-=2*Math.PI;return{...e,angle:s}}function q(e,i){const o=pe([...e]);return ve(o,i).map(n=>me(n,i))}function we(e,i){p.useEffect(()=>{if(!e)return;const o=l=>{const N=q(l.detail.topcodes,i),g=document.getElementById("video-canvas-video"),f=document.getElementById("video-canvas");if(!g||!f||g.readyState<2)return;const u=f.getContext("2d");if(!u)return;const A=g.videoWidth,D=g.videoHeight,j=A/D,L=D>A,M=Math.abs(j-16/9)<.1;let E,R;L?(E=A,R=D):M?(E=1280,R=720):(E=640,R=480),(f.width!==E||f.height!==R)&&(f.width=E,f.height=R),u.clearRect(0,0,f.width,f.height),u.drawImage(g,0,0,f.width,f.height),u.fillStyle="#00640080",u.strokeStyle="#006400",u.lineWidth=5;for(let O=0;O<N.length;O++){const $=N[O],B=f.width-$.x,Y=$.y;u.beginPath(),u.arc(B,Y,$.radius,0,Math.PI*2),u.fill(),u.stroke(),u.fillStyle="rgba(255, 255, 255, 1)",u.font="900 28px monospace",u.save(),u.translate(B,Y),u.rotate(i*(Math.PI/180)),u.textAlign="center",u.textBaseline="middle",u.fillText(`${O+1}`,0,0),u.restore(),u.fillStyle="#00640080"}},s=()=>{const l=document.getElementById("video-canvas-video"),c=document.getElementById("video-canvas"),N=document.querySelector(".video-container");if(l&&c&&N){l.style.display="none";const g=l.videoWidth||640,f=l.videoHeight||480,u=g/f,A=f>g,D=Math.abs(u-16/9)<.1;let j,L;A?(j=g,L=f):D?(j=1280,L=720):(j=640,L=480),(c.width!==j||c.height!==L)&&(c.width=j,c.height=L),N.contains(c)||N.appendChild(c);const M=c.classList.contains("rotated-sideways");c.style.display="block",c.style.position="relative",c.style.objectFit="contain",M?(c.style.width="auto",c.style.height="auto",c.style.maxWidth="50vh",c.style.maxHeight="none"):(c.style.width="100%",c.style.height="auto",c.style.maxHeight="50vh",c.style.maxWidth="")}},n=document.getElementById("video-canvas-video"),t=()=>{n&&s()},a=()=>{s()};n&&(n.readyState>=1&&s(),n.addEventListener("loadedmetadata",t),n.addEventListener("resize",a));const h=()=>{setTimeout(()=>{s()},100)};window.addEventListener("orientationchange",h),window.addEventListener("resize",h);const r=setInterval(()=>{const l=document.getElementById("video-canvas-video");l&&l.readyState>=1&&(s(),clearInterval(r))},100),v=setTimeout(()=>clearInterval(r),5e3);window.addEventListener("topcodes-detected",o);const x=document.getElementById("video-canvas");let m=null;return x&&(m=new MutationObserver(()=>{s()}),m.observe(x,{attributes:!0,attributeFilter:["class"]})),()=>{clearInterval(r),clearTimeout(v),window.removeEventListener("topcodes-detected",o),window.removeEventListener("orientationchange",h),window.removeEventListener("resize",h),n&&(n.removeEventListener("loadedmetadata",t),n.removeEventListener("resize",a)),m&&m.disconnect()}},[e,i])}function ge(e,i,o){p.useEffect(()=>{if(!e)return;const s=setInterval(()=>{i&&!e.synthesis.speaking&&o(!1)},100);return()=>clearInterval(s)},[e,i,o])}async function ye(e,i){const s=await(await fetch(`${e}/assets/js/howler.js`)).text(),n=document.createElement("script");n.textContent=s,document.head.appendChild(n);const a=await(await fetch(`${e}/assets/js/topcodes.js`)).text(),h=document.createElement("script");h.textContent=a,document.head.appendChild(h);let x=(await(await fetch(`${e}/assets/js/tangible.js`)).text()).replace("export default class Tangible","window.Tangible = class Tangible");x=x.replace(/setupTangible\(\) \{[\s\S]*?setVideoFrameCallback\("video-canvas", function \(jsonString\) \{[\s\S]*?\}, this\);[\s\S]*?\}/,`setupTangible() {
        let tangible = this;
        
        TopCodes.setVideoFrameCallback("video-canvas", function (jsonString) {
            var json = JSON.parse(jsonString);
            var topcodes = json.topcodes;
            tangible.currentCodes = topcodes;
            tangible.once = true;
            
            const event = new CustomEvent('topcodes-detected', { 
                detail: { topcodes: topcodes } 
            });
            window.dispatchEvent(event);
        }, this);
    }`);const m=document.createElement("script");if(m.textContent=x,document.head.appendChild(m),await new Promise(l=>setTimeout(l,200)),window.Tangible){const l=new window.Tangible;return l.setupTangible(),i(l,"Numbers",0),i(l,"Notifications",1),i(l,"Notifications",2),l}else return console.error("window.Tangible not available"),null}function xe(e,i,o,s){p.useEffect(()=>{(async()=>{try{const t=await ye(e,s);i(t),o(!1)}catch(t){console.error("Error loading scripts:",t),o(!1)}})()},[e,i,o,s])}let P=!1,H=[],_=null,V=!1;function ee(e){P&&(H.forEach(i=>clearTimeout(i)),H=[],e&&e.threads[0]&&e.threads[0].stop(),P=!1)}function I(){_&&(clearTimeout(_),_=null),V=!1}function Ce(e,i,o,s,n,t,a,h,r){p.useEffect(()=>{const v=l=>{l.touches.length===3?(l.preventDefault(),I(),ee(s),o&&s?(P=!0,(async()=>{const N=t[0];if(s.soundSets.Numbers){const g=new window.Howl({src:[`${n}/assets/sound/Numbers.mp3`],volume:1,sprite:s.soundSets.Numbers});s.threads[0]=g,g.play("c");const f=setTimeout(()=>{if(!P)return;g.play("b");const u=setTimeout(()=>{if(!P)return;g.play("a");const A=setTimeout(()=>{P&&(g.stop(),a(s,N,0,n),setTimeout(()=>{P=!1,H=[],h("Playing code gesture"),e()},100))},1e3);H.push(A)},1e3);H.push(u)},1e3);H.push(f)}})()):(h("Playing code gesture"),e())):l.touches.length===1&&(I(),V=!0,_=setTimeout(()=>{V&&(l.preventDefault(),h("Reading code gesture"),i(),V=!1)},750))},x=l=>{l.touches.length===0&&I()},m=l=>{V&&l.touches.length};return document.addEventListener("touchstart",v,{passive:!1}),document.addEventListener("touchend",x,{passive:!1}),document.addEventListener("touchmove",m,{passive:!1}),()=>{document.removeEventListener("touchstart",v),document.removeEventListener("touchend",x),document.removeEventListener("touchmove",m),I(),H.forEach(l=>clearTimeout(l)),H=[],P=!1}},r)}function te(e){return e.replace(/<br\/>/g,`
`).replace(/,\s*X:\[object Object\]/g,"").toLowerCase().replace(/(^|\n)([a-z])/g,(i,o,s)=>o+s.toUpperCase()).replace(/x/g,"X")}function K(e){const i=e.split(`
`).map(n=>n.trim().toLowerCase()),o=[];let s=!1;for(let n=0;n<i.length;n++){const t=i[n];if(t.startsWith("loop"))o.push({type:"loop",index:n+1});else if(t.startsWith("end loop")||t.startsWith("endloop")){if(o.length===0||o[o.length-1].type!=="loop")return{valid:!1,error:`Unexpected end loop at position ${n+1}`};o.pop()}else if(t.startsWith("if"))o.push({type:"if",index:n+1});else if(t.startsWith("end if")||t.startsWith("endif")){if(o.length===0||o[o.length-1].type!=="if")return{valid:!1,error:`Unexpected end if at position ${n+1}`};o.pop()}else if(t.startsWith("function"))o.push({type:"function",index:n+1});else if(t.startsWith("end function")||t.startsWith("endfunction")){if(o.length===0||o[o.length-1].type!=="function")return{valid:!1,error:`Unexpected end function at position ${n+1}`};o.pop()}else if(t.startsWith("x =")||t.startsWith("x="))s=!0;else if((t.startsWith("play x")||t.startsWith("if x"))&&!s)return{valid:!1,error:`Variable used at ${n+1} without being set.`}}if(o.length>0){const n=o[o.length-1];return{valid:!1,error:`Missing end tile for ${n.type} in position ${n.index}.`}}return{valid:!0}}function X(e){return e<.43?"5":e<1.4?"4":e<1.98?"3":e<2.85?"2":e<3.62?"1":e<4.3?"8":e<5.07?"7":"6"}function oe(e,i,o){const s=[];for(const n of e){const t=i[n.code];if(t)if(t===o.LOOP){const a=X(n.angle);s.push(`LOOP ${a} TIMES`)}else if(t===o.PLAY){const a=X(n.angle);s.push(`PLAY ${a}`)}else if(t===o.DELAY){const a=X(n.angle);s.push(`DELAY ${a}`)}else if(t===o.IF){const a=X(n.angle);s.push(`IF X < ${a}`)}else if(t===o.VARIABLE){const a=X(n.angle);s.push(`X = ${a}`)}else t===o.ENDLOOP?s.push("END LOOP"):t===o.PLAYX?s.push("PLAY X"):t===o.THREAD1?s.push("THREAD 1"):t===o.THREAD2?s.push("THREAD 2"):t===o.THREAD3?s.push("THREAD 3"):t===o.FUNCTION?s.push("FUNCTION"):t===o.ENDFUNCTION?s.push("END FUNCTION"):t===o.FUNCTIONCALL?s.push("CALL FUNCTION"):t===o.ENDIF?s.push("END IF"):t===o.ELSE?s.push("ELSE"):t===o.RANDOM?s.push("X = RANDOM"):t===o.INCREMENT?s.push("X = X + 1"):t===o.DECREMENT?s.push("X = X - 1"):s.push(t)}return s.join(`
`)}let b=!1,S=null;function Se(e,i,o,s,n,t,a,h){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(S&&(clearInterval(S),S=null),e.isAudioPlaying()||b){e.stopAllSounds(),ee(e),t(!1),b=!1;return}if(b=!0,i){const v=e.currentCodes;if(v&&v.length>0){const x=q([...v],h),m=oe(x,e.codeLibrary,e.commands);if(m){const l=te(m);n(l);const c=K(l);if(!c.valid&&c.error){e.readCode(c.error),b=!1;return}l&&l.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(l),t(!0),S=setInterval(()=>{e.isAudioPlaying()||(t(!1),b=!1,S&&(clearInterval(S),S=null))},100)):b=!1;return}}b=!1}const r=s.current?.value||o;if(r&&r.trim()){const v=K(r);if(!v.valid&&v.error){e.readCode(v.error),b=!1;return}}r&&r.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(r),t(!0),S=setInterval(()=>{e.isAudioPlaying()||(t(!1),b=!1,S&&(clearInterval(S),S=null))},100)):!r&&!i?(n(a),e.runTextCode(a),t(!0),S=setInterval(()=>{e.isAudioPlaying()||(t(!1),b=!1,S&&(clearInterval(S),S=null))},100)):(e.readCode("No code to run."),b=!1)}}let F=!1;function Ee(e,i,o,s,n,t,a,h){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(e.synthesis.speaking||F){e.synthesis.cancel(),t(!1),F=!1;return}if(e.isAudioPlaying()){e.stopAllSounds();return}if(F=!0,i){const v=e.currentCodes;if(v&&v.length>0){const x=q([...v],h),m=oe(x,e.codeLibrary,e.commands);if(m){const l=te(m);n(l),l&&l.trim()?(e.readCode(l),t(!0)):F=!1;return}}F=!1}const r=s.current?.value||o;r&&r.trim()?(e.readCode(r),t(!0)):!r&&!i?(n(a),e.readCode(a),t(!0)):(e.readCode("No code to read."),F=!1)}}function Q(e,i,o,s){const n=new window.Howl({src:[`${s}/assets/sound/${i}.mp3`],volume:1,sprite:e.soundSets[i]});e.threads[o]=n}const Te=()=>{if(typeof window<"u"&&window.Howler)try{const e=new window.Howl({src:["data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YQAAAAA="],volume:0,onload:()=>{e.play(),e.unload()}})}catch(e){console.error("Failed to initialize audio context:",e)}if(typeof window<"u"&&window.speechSynthesis)try{const e=new SpeechSynthesisUtterance("");e.volume=0,window.speechSynthesis.speak(e),window.speechSynthesis.cancel()}catch(e){console.error("Failed to initialize speech synthesis:",e)}},G="https://raw.githubusercontent.com/armbennett/tangible-11ty/main",be=[{value:"Numbers",label:"Numbers"},{value:"MusicLoops1",label:"Music Loops 1"},{value:"Mystery",label:"Mystery"},{value:"Notifications",label:"Notifications"},{value:"OdeToJoy",label:"Ode to Joy"},{value:"FurElise",label:"Fur Elise"}],Z=`Thread 1
Loop 4 times
Play 5
End loop
Play 7

Thread 2
Delay 4
Loop 3 times
Play 8
End loop`;function Ne(){const[e,i]=p.useState(!1),[o,s]=p.useState(""),[n,t]=p.useState(!0),[a,h]=p.useState(["Numbers","Notifications","Notifications"]),[r,v]=p.useState(null),[x,m]=p.useState(!1),[l,c]=p.useState(!1),[N,g]=p.useState(0),[f,u]=p.useState(0),[A,D]=p.useState(!1),[j,L]=p.useState(""),M=p.useRef(null),E=p.useRef(0),R=p.useRef(!1),O=p.useCallback((C,w,y)=>{Q(C,w,y,G)},[]);we(e,f),ge(r,x,m),xe(G,v,t,O);const $=Se(r,e,o,M,s,c,Z,f),B=Ee(r,e,o,M,s,m,Z,f);Ce($,B,e,r,G,a,Q,L,[r,e,o]);const Y=p.useCallback(()=>{const C=document.getElementById("video-canvas-video"),w=document.getElementById("video-canvas");if(!C||!w||C.readyState<1)return;const y=C.videoWidth,T=C.videoHeight,z=y/T,U=T>y,re=Math.abs(z-16/9)<.1,le=Math.abs(z-4/3)<.1;let k,W;U?(k=y,W=T):re?(k=1280,W=720):(k=640,W=480),(w.width!==k||w.height!==W)&&(w.width=k,w.height=W,window.TopCodes&&r&&(window.TopCodes.startStopVideoScan("video-canvas",r.mode),setTimeout(()=>{window.TopCodes&&r&&window.TopCodes.startStopVideoScan("video-canvas",r.mode)},150)))},[r]),se=C=>{C.stopPropagation();const w=Date.now();if(w-E.current<300)return;if(E.current=w,!r){console.error("Tangible instance not initialized");return}A||(Te(),D(!0));const y=!e;if(r.cameraStatus=y,window.TopCodes){if(y){const T=document.getElementById("video-canvas");T&&(T.width=1280,T.height=720),R.current=!1;const z=()=>{R.current||(R.current=!0,Y())};setTimeout(()=>{const U=document.getElementById("video-canvas-video");U&&(U.readyState>=1?z():U.addEventListener("loadedmetadata",z,{once:!0}))},200)}window.TopCodes.startStopVideoScan("video-canvas",r.mode),y||setTimeout(()=>{const T=document.getElementById("video-canvas-video");T&&(T.srcObject=null,T.remove()),delete window.TopCodes._mediaStreams["video-canvas"]},100)}i(y)},ne=C=>{C.stopPropagation();const w=Date.now();w-E.current<300||(E.current=w,g(y=>(y+90)%360))},ie=C=>{C.stopPropagation();const w=Date.now();w-E.current<300||(E.current=w,u(y=>(y+90)%360))},ae=(C,w)=>{const y=[...a];y[C]=w,h(y),r&&Q(r,w,C,G)};return d.jsxs("div",{className:"app-container",children:[d.jsx("div",{role:"status","aria-live":"assertive","aria-atomic":"true",className:"sr-only",children:j}),d.jsx("div",{className:"sr-only",role:"region","aria-label":"Touch gesture instructions",children:"Available touch gestures: Three-finger touch to play or stop code. Long press with one finger for one second to read or stop reading code."}),d.jsx(ce,{cameraEnabled:e,isPlaying:l,isReading:x,isLoading:n,tangibleInstance:r,onCameraToggle:se,onPlayStop:$,onRead:B}),d.jsx(ue,{cameraEnabled:e,rotation:N,readingOrderRotation:f,onRotate:ne,onReadingOrderRotate:ie}),d.jsx(fe,{cameraEnabled:e,codeText:o,textareaRef:M,soundSets:a,soundSetOptions:be,onCodeTextChange:s,onSoundSetChange:ae,placeholder:Z})]})}function je({}){return[{title:"TIBBL"},{name:"description",content:"TIBBL web application"}]}const Le=de(function(){return d.jsx(Ne,{})});export{Le as default,je as meta};
