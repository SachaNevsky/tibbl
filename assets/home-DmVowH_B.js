import{p as l,a as p,w as M}from"./chunk-EPOLDU6W-CP3WDhNt.js";function z({cameraEnabled:e,isPlaying:n,isReading:t,isLoading:r,tangibleInstance:i,onCameraToggle:s,onPlayStop:d,onRead:c}){return l.jsxs("header",{className:"header",role:"banner",children:[l.jsx("div",{className:"logo-container",children:l.jsx("img",{src:"https://armbennett.github.io/tangible-11ty/assets/img/tibbl-logo.png",alt:"Application logo",className:"logo"})}),l.jsxs("nav",{className:"header-buttons",role:"navigation","aria-label":"Main navigation",children:[l.jsxs("button",{className:"header-button",onClick:s,"aria-label":e?"Disable camera":"Enable camera","aria-pressed":e,disabled:r||!i,children:[l.jsx("i",{className:"fa-solid fa-camera fa-2xl","aria-hidden":"true"}),l.jsx("span",{children:"Camera"})]}),l.jsxs("button",{className:"header-button",onClick:d,"aria-label":n?"Stop code execution":"Play and execute code","aria-pressed":n,disabled:r||!i,children:[l.jsx("i",{className:`fa-solid ${n?"fa-stop":"fa-play"} fa-2xl`,"aria-hidden":"true"}),l.jsx("span",{children:n?"Stop":"Play"})]}),l.jsxs("button",{className:"header-button",onClick:c,"aria-label":t?"Stop reading code":"Read out code text","aria-pressed":t,disabled:r||!i,children:[l.jsx("i",{className:"fa-brands fa-readme fa-2xl","aria-hidden":"true"}),l.jsx("span",{children:t?"Stop":"Read"})]})]})]})}function O({cameraEnabled:e,rotation:n,onRotate:t}){const r=n===90||n===270;return l.jsxs(l.Fragment,{children:[e&&l.jsx("section",{className:"camera-section",role:"region","aria-label":"Camera view",children:l.jsxs("div",{className:"video-container",children:[l.jsx("canvas",{id:"video-canvas",width:"640",height:"480","aria-label":"Camera view and code tile detection overlay",className:r?"rotated-sideways":"",style:{transform:`rotate(${n}deg)`}}),l.jsx("button",{className:"rotate-button",onClick:t,"aria-label":`Rotate camera view 90 degrees clockwise (currently ${n} degrees)`,type:"button",children:l.jsx("i",{className:"fa-solid fa-rotate-right","aria-hidden":"true"})})]})}),!e&&l.jsx("canvas",{id:"video-canvas",width:"640",height:"480",style:{display:"none"}})]})}function W({threadNumber:e,value:n,onChange:t,soundSets:r}){const i=`thread${e}`,s=`Thread ${e}`;return l.jsxs("div",{className:"dropdown-group",children:[l.jsx("label",{htmlFor:i,className:"dropdown-label",children:s}),l.jsx("select",{id:i,className:"dropdown",value:n,onChange:d=>t(d.target.value),"aria-label":`Select ${s} sound options`,children:r.map(d=>l.jsx("option",{value:d.value,children:d.label},d.value))})]})}function V({cameraEnabled:e,codeText:n,textareaRef:t,soundSets:r,soundSetOptions:i,onCodeTextChange:s,onSoundSetChange:d}){return l.jsxs("section",{className:`output-section ${e?"camera-active":""}`,role:"region","aria-label":"Code output and thread selection",children:[l.jsx("div",{className:"textbox-container",children:l.jsx("textarea",{ref:t,value:n,onChange:c=>s(c.target.value),className:"output-textbox",placeholder:`Thread 1
Loop 4 times
Play 5
End loop
Play 7

Thread 2
Delay 4
Loop 3 times
Play 8
End loop`,"aria-label":"Code output text area"})}),l.jsxs("div",{className:"dropdown-container",children:[l.jsx(W,{threadNumber:1,value:r[0],onChange:c=>d(0,c),soundSets:i}),l.jsx(W,{threadNumber:2,value:r[1],onChange:c=>d(1,c),soundSets:i}),l.jsx(W,{threadNumber:3,value:r[2],onChange:c=>d(2,c),soundSets:i})]})]})}function D(e){p.useEffect(()=>{if(!e)return;const n=c=>{const f=c.detail.topcodes,h=document.getElementById("video-canvas-video"),u=document.getElementById("video-canvas");if(!h||!u||h.readyState<2)return;const o=u.getContext("2d");if(!o)return;const b=h.videoWidth,T=h.videoHeight,R=T>b;o.clearRect(0,0,u.width,u.height),o.drawImage(h,0,0,u.width,u.height),o.fillStyle="rgba(255, 0, 0, 0.3)",o.strokeStyle="rgba(255, 0, 0, 0.8)",o.lineWidth=2;for(let y=0;y<f.length;y++){const j=f[y],C=u.width-j.x,N=j.y;o.beginPath(),o.arc(C,N,j.radius,0,Math.PI*2),o.fill(),o.stroke(),o.fillStyle="rgba(255, 255, 255, 1)",o.font="14px monospace",o.textAlign="center",o.textBaseline="middle",o.fillText(`(${Math.round(C)}, ${Math.round(N)})`,C,N),o.fillStyle="rgba(255, 0, 0, 0.3)"}o.fillStyle="rgba(255, 0, 0, 0.7)",o.fillRect(0,0,100,44),o.fillStyle="rgba(255, 255, 255, 1)",o.font="bold 14px monospace",o.textAlign="left",o.textBaseline="middle",o.fillText(R?"Portrait":"Landscape",5,10),o.fillText(`(${u.width} x ${u.height})`,5,30),o.fillStyle="rgba(0, 100, 0, 0.8)",o.fillRect(0,u.height-110,140,110),o.fillStyle="rgba(255, 255, 255, 1)",o.font="12px monospace",o.textAlign="left",o.textBaseline="top",o.fillText(`Video: ${b}x${T}`,5,u.height-105),o.fillText(`Canvas: ${u.width}x${u.height}`,5,u.height-90),o.fillText(`Aspect: ${(b/T).toFixed(2)}`,5,u.height-75),o.fillText(`TopCodes: ${f.length}`,5,u.height-60),o.fillText(`Browser: ${navigator.userAgent.includes("Safari")?"Safari":navigator.userAgent.includes("Chrome")?"Chrome":navigator.userAgent.includes("Firefox")?"Firefox":"Other"}`,5,u.height-45),o.fillText(`Platform: ${navigator.platform}`,5,u.height-30),o.fillText(`Ready: ${h.readyState}/4`,5,u.height-15)},t=()=>{const c=document.getElementById("video-canvas-video"),a=document.getElementById("video-canvas"),f=document.querySelector(".video-container");if(c&&a&&f){c.style.display="none",(a.width!==640||a.height!==480)&&(a.width=640,a.height=480),f.contains(a)||f.appendChild(a);const h=a.classList.contains("rotated-sideways");a.style.display="block",a.style.position="relative",a.style.objectFit="contain",h?(a.style.width="auto",a.style.height="auto",a.style.maxWidth="50vh",a.style.maxHeight="none"):(a.style.width="100%",a.style.height="auto",a.style.maxHeight="50vh",a.style.maxWidth="")}},r=setInterval(()=>{document.getElementById("video-canvas-video")&&(t(),clearInterval(r))},100),i=setTimeout(()=>clearInterval(r),5e3);window.addEventListener("topcodes-detected",n);const s=document.getElementById("video-canvas");let d=null;return s&&(d=new MutationObserver(()=>{t()}),d.observe(s,{attributes:!0,attributeFilter:["class"]})),()=>{clearInterval(r),clearTimeout(i),window.removeEventListener("topcodes-detected",n),d&&d.disconnect()}},[e])}function U(e,n,t){p.useEffect(()=>{if(!e)return;const r=setInterval(()=>{n&&!e.synthesis.speaking&&t(!1)},100);return()=>clearInterval(r)},[e,n,t])}async function _(e,n){const r=await(await fetch(`${e}/assets/js/howler.js`)).text(),i=document.createElement("script");i.textContent=r,document.head.appendChild(i);const d=await(await fetch(`${e}/assets/js/topcodes.js`)).text(),c=document.createElement("script");c.textContent=d,document.head.appendChild(c);let h=(await(await fetch(`${e}/assets/js/tangible.js`)).text()).replace("export default class Tangible","window.Tangible = class Tangible");h=h.replace(/setupTangible\(\) \{[\s\S]*?setVideoFrameCallback\("video-canvas", function \(jsonString\) \{[\s\S]*?\}, this\);[\s\S]*?\}/,`setupTangible() {
        this.setVideoCanvasHeight('video-canvas');
        let tangible = this;
        
        TopCodes.setVideoFrameCallback("video-canvas", function (jsonString) {
            var json = JSON.parse(jsonString);
            var topcodes = json.topcodes;
            tangible.currentCodes = topcodes;
            tangible.once = true;
            
            const event = new CustomEvent('topcodes-detected', { 
                detail: { topcodes: topcodes } 
            });
            window.dispatchEvent(event);
        }, this);
    }`);const u=document.createElement("script");if(u.textContent=h,document.head.appendChild(u),await new Promise(o=>setTimeout(o,200)),window.Tangible){const o=new window.Tangible;return o.setupTangible(),n(o,"Numbers",0),n(o,"Notifications",1),n(o,"Notifications",2),o}else return console.error("window.Tangible not available"),null}function J(e,n,t,r){p.useEffect(()=>{(async()=>{try{const s=await _(e,r);n(s),t(!1)}catch(s){console.error("Error loading scripts:",s),t(!1)}})()},[e,n,t,r])}let g=!1,w=[];function X(e,n,t,r){p.useEffect(()=>{const i=s=>{s.touches.length===3&&(s.preventDefault(),g&&(w.forEach(d=>clearTimeout(d)),w=[],t&&t.synthesis.cancel(),g=!1),n&&t?(g=!0,(async()=>{t.readCode("3");const c=setTimeout(async()=>{if(!g)return;t.readCode("2");const a=setTimeout(async()=>{if(!g)return;t.readCode("1");const f=setTimeout(()=>{g&&(g=!1,w=[],e())},1e3);w.push(f)},1e3);w.push(a)},1e3);w.push(c)})()):e())};return document.addEventListener("touchstart",i,{passive:!1}),()=>{document.removeEventListener("touchstart",i),w.forEach(s=>clearTimeout(s)),w=[],g=!1}},r)}function B(e){return e.replace(/<br\/>/g,`
`).replace(/,\s*X:\[object Object\]/g,"").toLowerCase().replace(/(^|\n)([a-z])/g,(n,t,r)=>t+r.toUpperCase()).replace(/x/g,"X")}function A(e){const n=e.split(`
`).map(i=>i.trim().toLowerCase()),t=[];let r=!1;for(let i=0;i<n.length;i++){const s=n[i];if(s.startsWith("loop"))t.push({type:"loop",index:i+1});else if(s.startsWith("end loop")||s.startsWith("endloop")){if(t.length===0||t[t.length-1].type!=="loop")return{valid:!1,error:`Unexpected end loop at position ${i+1}`};t.pop()}else if(s.startsWith("if"))t.push({type:"if",index:i+1});else if(s.startsWith("end if")||s.startsWith("endif")){if(t.length===0||t[t.length-1].type!=="if")return{valid:!1,error:`Unexpected end if at position ${i+1}`};t.pop()}else if(s.startsWith("function"))t.push({type:"function",index:i+1});else if(s.startsWith("end function")||s.startsWith("endfunction")){if(t.length===0||t[t.length-1].type!=="function")return{valid:!1,error:`Unexpected end function at position ${i+1}`};t.pop()}else if(s.startsWith("x =")||s.startsWith("x="))r=!0;else if((s.startsWith("play x")||s.startsWith("if x"))&&!r)return{valid:!1,error:`Variable used at ${i+1} without being set.`}}if(t.length>0){const i=t[t.length-1];return{valid:!1,error:`Missing end tile for ${i.type} in position ${i.index}.`}}return{valid:!0}}let x=!1,m=null;function G(e,n,t,r,i,s){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(m&&(clearInterval(m),m=null),e.isAudioPlaying()||x){e.stopAllSounds(),s(!1),x=!1;return}if(x=!0,n){const c=e.scanCode();if(c){const a=B(c);i(a);const f=A(a);if(!f.valid&&f.error){e.readCode(f.error),x=!1;return}a&&a.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(a),s(!0),m=setInterval(()=>{e.isAudioPlaying()||(s(!1),x=!1,m&&(clearInterval(m),m=null))},100)):x=!1;return}x=!1}const d=r.current?.value||t;if(d&&d.trim()){const c=A(d);if(!c.valid&&c.error){e.readCode(c.error),x=!1;return}}d&&d.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(d),s(!0),m=setInterval(()=>{e.isAudioPlaying()||(s(!1),x=!1,m&&(clearInterval(m),m=null))},100)):(e.readCode("No code to run."),x=!1)}}let S=!1;function q(e,n,t,r,i,s){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(e.synthesis.speaking||S){e.synthesis.cancel(),s(!1),S=!1;return}if(e.isAudioPlaying()){e.stopAllSounds();return}if(S=!0,n){const c=e.scanCode();if(c){const a=B(c);i(a),a&&a.trim()?(e.readCode(a),s(!0)):S=!1;return}S=!1}const d=r.current?.value||t;d&&d.trim()?(e.readCode(d),s(!0)):(e.readCode("No code to read."),S=!1)}}function P(e,n,t,r){const i=new window.Howl({src:[`${r}/assets/sound/${n}.mp3`],volume:.2,sprite:e.soundSets[n]});e.threads[t]=i}const k="https://raw.githubusercontent.com/armbennett/tangible-11ty/main",Y=[{value:"Numbers",label:"Numbers"},{value:"MusicLoops1",label:"Music Loops 1"},{value:"Mystery",label:"Mystery"},{value:"Notifications",label:"Notifications"},{value:"OdeToJoy",label:"Ode to Joy"},{value:"FurElise",label:"Fur Elise"}];function K(){const[e,n]=p.useState(!1),[t,r]=p.useState(""),[i,s]=p.useState(!0),[d,c]=p.useState(["Numbers","Notifications","Notifications"]),[a,f]=p.useState(null),[h,u]=p.useState(!1),[o,b]=p.useState(!1),[T,R]=p.useState(0),y=p.useRef(null),j=p.useCallback((v,E,$)=>{P(v,E,$,k)},[]);D(e),U(a,h,u),J(k,f,s,j);const C=G(a,e,t,y,r,b),N=q(a,e,t,y,r,u);X(C,e,a,[a,e,t]);const L=()=>{if(!a){console.error("Tangible instance not initialized");return}const v=!e;a.cameraStatus=v,window.TopCodes&&(window.TopCodes.startStopVideoScan("video-canvas",a.mode),v||setTimeout(()=>{delete window.TopCodes._mediaStreams["video-canvas"]},100)),n(v)},H=()=>{R(v=>(v+90)%360)},F=(v,E)=>{const $=[...d];$[v]=E,c($),a&&P(a,E,v,k)};return l.jsxs("div",{className:"app-container",children:[l.jsx(z,{cameraEnabled:e,isPlaying:o,isReading:h,isLoading:i,tangibleInstance:a,onCameraToggle:L,onPlayStop:C,onRead:N}),l.jsx(O,{cameraEnabled:e,rotation:T,onRotate:H}),l.jsx(V,{cameraEnabled:e,codeText:t,textareaRef:y,soundSets:d,soundSetOptions:Y,onCodeTextChange:r,onSoundSetChange:F})]})}function Z({}){return[{title:"TIBBL"},{name:"description",content:"TIBBL web application"}]}const I=M(function(){return l.jsx(K,{})});export{I as default,Z as meta};
