import{p as r,a as p,w as F}from"./chunk-EPOLDU6W-CP3WDhNt.js";function z({cameraEnabled:e,isPlaying:n,isReading:t,isLoading:i,tangibleInstance:s,onCameraToggle:a,onPlayStop:l,onRead:c}){return r.jsxs("header",{className:"header",role:"banner",children:[r.jsx("div",{className:"logo-container",children:r.jsx("img",{src:"https://armbennett.github.io/tangible-11ty/assets/img/tibbl-logo.png",alt:"Application logo",className:"logo"})}),r.jsxs("nav",{className:"header-buttons",role:"navigation","aria-label":"Main navigation",children:[r.jsxs("button",{className:"header-button",onClick:a,"aria-label":e?"Disable camera":"Enable camera","aria-pressed":e,disabled:i||!s,children:[r.jsx("i",{className:"fa-solid fa-camera fa-2xl","aria-hidden":"true"}),r.jsx("span",{children:"Camera"})]}),r.jsxs("button",{className:"header-button",onClick:l,"aria-label":n?"Stop code execution":"Play and execute code","aria-pressed":n,disabled:i||!s,children:[r.jsx("i",{className:`fa-solid ${n?"fa-stop":"fa-play"} fa-2xl`,"aria-hidden":"true"}),r.jsx("span",{children:n?"Stop":"Play"})]}),r.jsxs("button",{className:"header-button",onClick:c,"aria-label":t?"Stop reading code":"Read out code text","aria-pressed":t,disabled:i||!s,children:[r.jsx("i",{className:"fa-brands fa-readme fa-2xl","aria-hidden":"true"}),r.jsx("span",{children:t?"Stop":"Read"})]})]})]})}function D({cameraEnabled:e,rotation:n,onRotate:t}){const i=n===90||n===270;return r.jsxs(r.Fragment,{children:[e&&r.jsx("section",{className:"camera-section",role:"region","aria-label":"Camera view",children:r.jsxs("div",{className:"video-container",children:[r.jsx("canvas",{id:"video-canvas",width:"640",height:"480","aria-label":"Camera view and code tile detection overlay",className:i?"rotated-sideways":"",style:{transform:`rotate(${n}deg)`}}),r.jsx("button",{className:"rotate-button",onClick:t,"aria-label":`Rotate camera view 90 degrees clockwise (currently ${n} degrees)`,type:"button",children:r.jsx("i",{className:"fa-solid fa-rotate-right","aria-hidden":"true"})})]})}),!e&&r.jsx("canvas",{id:"video-canvas",width:"640",height:"480",style:{display:"none"}})]})}function W({threadNumber:e,value:n,onChange:t,soundSets:i}){const s=`thread${e}`,a=`Thread ${e}`;return r.jsxs("div",{className:"dropdown-group",children:[r.jsx("label",{htmlFor:s,className:"dropdown-label",children:a}),r.jsx("select",{id:s,className:"dropdown",value:n,onChange:l=>t(l.target.value),"aria-label":`Select ${a} sound options`,children:i.map(l=>r.jsx("option",{value:l.value,children:l.label},l.value))})]})}function O({cameraEnabled:e,codeText:n,textareaRef:t,soundSets:i,soundSetOptions:s,onCodeTextChange:a,onSoundSetChange:l}){return r.jsxs("section",{className:`output-section ${e?"camera-active":""}`,role:"region","aria-label":"Code output and thread selection",children:[r.jsx("div",{className:"textbox-container",children:r.jsx("textarea",{ref:t,value:n,onChange:c=>a(c.target.value),className:"output-textbox",placeholder:`Thread 1
Loop 4 times
Play 5
End loop
Play 7

Thread 2
Delay 4
Loop 3 times
Play 8
End loop`,"aria-label":"Code output text area"})}),r.jsxs("div",{className:"dropdown-container",children:[r.jsx(W,{threadNumber:1,value:i[0],onChange:c=>l(0,c),soundSets:s}),r.jsx(W,{threadNumber:2,value:i[1],onChange:c=>l(1,c),soundSets:s}),r.jsx(W,{threadNumber:3,value:i[2],onChange:c=>l(2,c),soundSets:s})]})]})}function U(e){p.useEffect(()=>{if(!e)return;const n=c=>{const f=c.detail.topcodes,h=document.getElementById("video-canvas-video"),u=document.getElementById("video-canvas");if(!h||!u||h.readyState<2)return;const d=u.getContext("2d");if(!d)return;const $=h.videoWidth,T=h.videoHeight>$;d.save(),T&&(d.translate(u.width/2,u.height/2),d.rotate(-Math.PI/2),d.translate(-u.width/2,-u.height/2)),d.drawImage(h,0,0,u.width,u.height),d.restore(),d.fillStyle="rgba(255, 0, 0, 0.3)",d.strokeStyle="rgba(255, 0, 0, 0.8)",d.lineWidth=2;for(let y=0;y<f.length;y++){const C=f[y];let S=u.width-C.x,b=C.y;T&&(S=u.width-C.y,b=u.width-C.x),d.beginPath(),d.arc(S,b,C.radius,0,Math.PI*2),d.fill(),d.stroke(),d.fillStyle="rgba(255, 255, 255, 1)",d.font="14px monospace",d.textAlign="center",d.textBaseline="middle",d.fillText(`(${Math.round(S)}, ${Math.round(b)})`,S,b),d.fillStyle="rgba(255, 0, 0, 0.3)"}d.fillStyle="rgba(255, 0, 0, 0.7)",d.fillRect(0,0,10,10)},t=()=>{const c=document.getElementById("video-canvas-video"),o=document.getElementById("video-canvas"),f=document.querySelector(".video-container");if(c&&o&&f){c.style.display="none",(o.width!==640||o.height!==480)&&(o.width=640,o.height=480),f.contains(o)||f.appendChild(o);const h=o.classList.contains("rotated-sideways");o.style.display="block",o.style.position="relative",o.style.objectFit="contain",h?(o.style.width="auto",o.style.height="auto",o.style.maxWidth="50vh",o.style.maxHeight="none"):(o.style.width="100%",o.style.height="auto",o.style.maxHeight="50vh",o.style.maxWidth="")}},i=setInterval(()=>{document.getElementById("video-canvas-video")&&(t(),clearInterval(i))},100),s=setTimeout(()=>clearInterval(i),5e3);window.addEventListener("topcodes-detected",n);const a=document.getElementById("video-canvas");let l=null;return a&&(l=new MutationObserver(()=>{t()}),l.observe(a,{attributes:!0,attributeFilter:["class"]})),()=>{clearInterval(i),clearTimeout(s),window.removeEventListener("topcodes-detected",n),l&&l.disconnect()}},[e])}function V(e,n,t){p.useEffect(()=>{if(!e)return;const i=setInterval(()=>{n&&!e.synthesis.speaking&&t(!1)},100);return()=>clearInterval(i)},[e,n,t])}async function _(e,n){const i=await(await fetch(`${e}/assets/js/howler.js`)).text(),s=document.createElement("script");s.textContent=i,document.head.appendChild(s);const l=await(await fetch(`${e}/assets/js/topcodes.js`)).text(),c=document.createElement("script");c.textContent=l,document.head.appendChild(c);let h=(await(await fetch(`${e}/assets/js/tangible.js`)).text()).replace("export default class Tangible","window.Tangible = class Tangible");h=h.replace(/setupTangible\(\) \{[\s\S]*?setVideoFrameCallback\("video-canvas", function \(jsonString\) \{[\s\S]*?\}, this\);[\s\S]*?\}/,`setupTangible() {
        this.setVideoCanvasHeight('video-canvas');
        let tangible = this;
        
        TopCodes.setVideoFrameCallback("video-canvas", function (jsonString) {
            var json = JSON.parse(jsonString);
            var topcodes = json.topcodes;
            tangible.currentCodes = topcodes;
            tangible.once = true;
            
            const event = new CustomEvent('topcodes-detected', { 
                detail: { topcodes: topcodes } 
            });
            window.dispatchEvent(event);
        }, this);
    }`);const u=document.createElement("script");if(u.textContent=h,document.head.appendChild(u),await new Promise(d=>setTimeout(d,200)),window.Tangible){const d=new window.Tangible;return d.setupTangible(),n(d,"Numbers",0),n(d,"Notifications",1),n(d,"Notifications",2),d}else return console.error("window.Tangible not available"),null}function J(e,n,t,i){p.useEffect(()=>{(async()=>{try{const a=await _(e,i);n(a),t(!1)}catch(a){console.error("Error loading scripts:",a),t(!1)}})()},[e,n,t,i])}let w=!1,g=[];function X(e,n,t,i){p.useEffect(()=>{const s=a=>{a.touches.length===3&&(a.preventDefault(),w&&(g.forEach(l=>clearTimeout(l)),g=[],t&&t.synthesis.cancel(),w=!1),n&&t?(w=!0,(async()=>{t.readCode("3");const c=setTimeout(async()=>{if(!w)return;t.readCode("2");const o=setTimeout(async()=>{if(!w)return;t.readCode("1");const f=setTimeout(()=>{w&&(w=!1,g=[],e())},1e3);g.push(f)},1e3);g.push(o)},1e3);g.push(c)})()):e())};return document.addEventListener("touchstart",s,{passive:!1}),()=>{document.removeEventListener("touchstart",s),g.forEach(a=>clearTimeout(a)),g=[],w=!1}},i)}function L(e){return e.replace(/<br\/>/g,`
`).replace(/,\s*X:\[object Object\]/g,"").toLowerCase().replace(/(^|\n)([a-z])/g,(n,t,i)=>t+i.toUpperCase()).replace(/x/g,"X")}function H(e){const n=e.split(`
`).map(s=>s.trim().toLowerCase()),t=[];let i=!1;for(let s=0;s<n.length;s++){const a=n[s];if(a.startsWith("loop"))t.push({type:"loop",index:s+1});else if(a.startsWith("end loop")||a.startsWith("endloop")){if(t.length===0||t[t.length-1].type!=="loop")return{valid:!1,error:`Unexpected end loop at position ${s+1}`};t.pop()}else if(a.startsWith("if"))t.push({type:"if",index:s+1});else if(a.startsWith("end if")||a.startsWith("endif")){if(t.length===0||t[t.length-1].type!=="if")return{valid:!1,error:`Unexpected end if at position ${s+1}`};t.pop()}else if(a.startsWith("function"))t.push({type:"function",index:s+1});else if(a.startsWith("end function")||a.startsWith("endfunction")){if(t.length===0||t[t.length-1].type!=="function")return{valid:!1,error:`Unexpected end function at position ${s+1}`};t.pop()}else if(a.startsWith("x =")||a.startsWith("x="))i=!0;else if((a.startsWith("play x")||a.startsWith("if x"))&&!i)return{valid:!1,error:`Variable used at ${s+1} without being set.`}}if(t.length>0){const s=t[t.length-1];return{valid:!1,error:`Missing end tile for ${s.type} in position ${s.index}.`}}return{valid:!0}}let x=!1,m=null;function G(e,n,t,i,s,a){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(m&&(clearInterval(m),m=null),e.isAudioPlaying()||x){e.stopAllSounds(),a(!1),x=!1;return}if(x=!0,n){const c=e.scanCode();if(c){const o=L(c);s(o);const f=H(o);if(!f.valid&&f.error){e.readCode(f.error),x=!1;return}o&&o.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(o),a(!0),m=setInterval(()=>{e.isAudioPlaying()||(a(!1),x=!1,m&&(clearInterval(m),m=null))},100)):x=!1;return}x=!1}const l=i.current?.value||t;if(l&&l.trim()){const c=H(l);if(!c.valid&&c.error){e.readCode(c.error),x=!1;return}}l&&l.trim()?(e.codeThreads=[[],[],[]],e.runTextCode(l),a(!0),m=setInterval(()=>{e.isAudioPlaying()||(a(!1),x=!1,m&&(clearInterval(m),m=null))},100)):(e.readCode("No code to run."),x=!1)}}let j=!1;function q(e,n,t,i,s,a){return()=>{if(!e){console.error("Tangible instance not initialized");return}if(e.synthesis.speaking||j){e.synthesis.cancel(),a(!1),j=!1;return}if(e.isAudioPlaying()){e.stopAllSounds();return}if(j=!0,n){const c=e.scanCode();if(c){const o=L(c);s(o),o&&o.trim()?(e.readCode(o),a(!0)):j=!1;return}j=!1}const l=i.current?.value||t;l&&l.trim()?(e.readCode(l),a(!0)):(e.readCode("No code to read."),j=!1)}}function P(e,n,t,i){const s=new window.Howl({src:[`${i}/assets/sound/${n}.mp3`],volume:.2,sprite:e.soundSets[n]});e.threads[t]=s}const R="https://raw.githubusercontent.com/armbennett/tangible-11ty/main",Y=[{value:"Numbers",label:"Numbers"},{value:"MusicLoops1",label:"Music Loops 1"},{value:"Mystery",label:"Mystery"},{value:"Notifications",label:"Notifications"},{value:"OdeToJoy",label:"Ode to Joy"},{value:"FurElise",label:"Fur Elise"}];function K(){const[e,n]=p.useState(!1),[t,i]=p.useState(""),[s,a]=p.useState(!0),[l,c]=p.useState(["Numbers","Notifications","Notifications"]),[o,f]=p.useState(null),[h,u]=p.useState(!1),[d,$]=p.useState(!1),[k,T]=p.useState(0),y=p.useRef(null),C=p.useCallback((v,N,E)=>{P(v,N,E,R)},[]);U(e),V(o,h,u),J(R,f,a,C);const S=G(o,e,t,y,i,$),b=q(o,e,t,y,i,u);X(S,e,o,[o,e,t]);const M=()=>{if(!o){console.error("Tangible instance not initialized");return}const v=!e;o.cameraStatus=v,window.TopCodes&&(window.TopCodes.startStopVideoScan("video-canvas",o.mode),v||setTimeout(()=>{delete window.TopCodes._mediaStreams["video-canvas"]},100)),n(v)},B=()=>{T(v=>(v+90)%360)},A=(v,N)=>{const E=[...l];E[v]=N,c(E),o&&P(o,N,v,R)};return r.jsxs("div",{className:"app-container",children:[r.jsx(z,{cameraEnabled:e,isPlaying:d,isReading:h,isLoading:s,tangibleInstance:o,onCameraToggle:M,onPlayStop:S,onRead:b}),r.jsx(D,{cameraEnabled:e,rotation:k,onRotate:B}),r.jsx(O,{cameraEnabled:e,codeText:t,textareaRef:y,soundSets:l,soundSetOptions:Y,onCodeTextChange:i,onSoundSetChange:A})]})}function Z({}){return[{title:"TIBBL"},{name:"description",content:"TIBBL web application"}]}const I=F(function(){return r.jsx(K,{})});export{I as default,Z as meta};
